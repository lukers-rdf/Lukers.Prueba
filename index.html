<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro - Sistema de Gesti√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#818cf8;
            --accent:#06b6d4;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;--purple:#a855f7;
            --bg-main:#0f172a;--bg-card:#1e293b;--bg-card-hover:#334155;--bg-input:#334155;
            --text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;
            --border:rgba(255,255,255,0.1);--radius:16px;--radius-sm:10px;
            --sidebar-width:260px;--transition:all 0.3s ease;
            --shadow:0 4px 6px -1px rgba(0,0,0,0.3);--shadow-lg:0 20px 25px -5px rgba(0,0,0,0.3);
        }
        [data-theme="light"] {
            --bg-main:#f1f5f9;--bg-card:#ffffff;--bg-card-hover:#f8fafc;--bg-input:#f1f5f9;
            --text-primary:#0f172a;--text-secondary:#64748b;--text-muted:#94a3b8;
            --border:rgba(0,0,0,0.1);--shadow:0 4px 6px -1px rgba(0,0,0,0.1);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:var(--bg-main);color:var(--text-primary);min-height:100vh}
        
        /* Auth */
        .auth-container{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        .auth-box{background:var(--bg-card);border-radius:var(--radius);padding:40px;width:100%;max-width:420px;box-shadow:var(--shadow-lg)}
        .auth-logo{text-align:center;margin-bottom:32px}
        .auth-logo-icon{width:70px;height:70px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:2rem;color:#fff}
        .auth-logo h1{font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .auth-tabs{display:flex;gap:8px;margin-bottom:24px}
        .auth-tab{flex:1;padding:12px;background:var(--bg-input);border:none;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;font-weight:600;transition:var(--transition)}
        .auth-tab.active{background:var(--primary);color:white}
        .auth-form{display:none}
        .auth-form.active{display:block}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:0.875rem;color:var(--text-secondary)}
        .form-control{width:100%;padding:14px 16px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:1rem;transition:var(--transition)}
        .form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.2)}
        select.form-control{cursor:pointer}
        textarea.form-control{min-height:80px;resize:vertical}
        
        /* Buttons */
        .btn{padding:12px 20px;border:none;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px;font-size:0.9rem}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(99,102,241,0.4)}
        .btn-secondary{background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border)}
        .btn-success{background:var(--success);color:white}
        .btn-warning{background:var(--warning);color:white}
        .btn-danger{background:var(--danger);color:white}
        .btn-sm{padding:8px 14px;font-size:0.8rem}
        .btn-block{width:100%;justify-content:center}
        .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
        .btn-icon{width:36px;height:36px;padding:0;justify-content:center}
        
        /* Layout */
        .app-container{display:none;height:100vh;overflow:hidden}
        .sidebar{position:fixed;left:0;top:0;width:var(--sidebar-width);height:100vh;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
        .logo-container{display:flex;align-items:center;gap:12px}
        .logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1.2rem}
        .logo-title{font-size:1.2rem;font-weight:800;color:var(--text-primary)}
        .logo-subtitle{font-size:0.7rem;color:var(--text-muted)}
        
        .sidebar-nav{flex:1;padding:16px;overflow-y:auto}
        .nav-section-title{font-size:0.7rem;font-weight:700;text-transform:uppercase;color:var(--text-muted);padding:12px 12px 8px;letter-spacing:0.5px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;transition:var(--transition);margin-bottom:4px;font-size:0.9rem}
        .nav-item:hover{background:var(--bg-input);color:var(--text-primary)}
        .nav-item.active{background:var(--primary);color:white}
        
        .sidebar-footer{padding:16px;border-top:1px solid var(--border)}
        .sync-status{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:12px;font-size:0.8rem}
        .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--success);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .sync-dot.warning{background:var(--warning);animation:none}
        .sync-dot.error{background:var(--danger);animation:none}
        .user-info{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);margin-bottom:12px}
        .user-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--accent));border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
        .user-name{font-weight:600;font-size:0.9rem}
        .user-role{font-size:0.75rem;color:var(--text-muted)}
        .role-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:0.7rem;font-weight:700;text-transform:uppercase}
        .role-badge.jefe{background:rgba(245,158,11,0.2);color:var(--warning)}
        .role-badge.trabajador{background:rgba(59,130,246,0.2);color:var(--info)}
        .theme-toggle{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .theme-btn{width:44px;height:24px;background:var(--bg-input);border:none;border-radius:12px;cursor:pointer;position:relative}
        .theme-btn::after{content:'‚òÄÔ∏è';position:absolute;left:4px;top:2px;font-size:12px;transition:var(--transition)}
        [data-theme="light"] .theme-btn::after{content:'üåô';left:auto;right:4px}
        
        /* Main Content */
        .main-content{margin-left:var(--sidebar-width);display:flex;flex-direction:column;height:100vh;overflow:hidden}
        .header{background:var(--bg-card);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:12px}
        .header-left h1{font-size:1.5rem;font-weight:800}
        .header-left p{font-size:0.85rem;color:var(--text-muted)}
        .header-actions{display:flex;gap:10px;flex-wrap:wrap}
        .content-area{flex:1;overflow-y:auto;padding:24px}
        
        /* Update Banner */
        .update-banner{position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(135deg,var(--primary),var(--purple));padding:0;max-height:0;overflow:hidden;transition:all 0.3s ease}
        .update-banner.show{padding:14px 24px;max-height:60px}
        .update-banner-content{display:flex;align-items:center;justify-content:center;gap:16px}
        .update-banner span{color:white;font-weight:600;font-size:0.9rem}
        .update-banner button{padding:8px 20px;background:white;color:var(--primary);border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:var(--transition)}
        .update-banner button:hover{transform:scale(1.05)}
        .update-banner .close-btn{background:transparent;color:white;padding:4px 10px;font-size:1.2rem}
        
        /* Loading Overlay */
        .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center}
        .loading-overlay.active{display:flex}
        .loading-content{text-align:center;color:white}
        .spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{font-size:1rem;margin-bottom:8px}
        .loading-subtext{font-size:0.85rem;color:var(--text-secondary)}
        .progress-bar{width:200px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;margin:16px auto 0;overflow:hidden}
        .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.3s}
        
        /* Views */
        .view{display:none}
        .view.active{display:block}
        
        /* Filters Bar */
        .filters-bar{background:var(--bg-card);padding:16px;border-radius:var(--radius-sm);margin-bottom:20px;display:flex;gap:16px;flex-wrap:wrap;align-items:center;box-shadow:var(--shadow)}
        .filter-group{display:flex;align-items:center;gap:8px}
        .filter-group label{font-size:0.8rem;font-weight:600;color:var(--text-secondary)}
        .filter-select{padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:0.85rem;cursor:pointer}
        
        /* Stats Grid */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
        .stat-card{background:var(--bg-card);padding:20px;border-radius:var(--radius-sm);box-shadow:var(--shadow);transition:var(--transition)}
        .stat-card:hover{transform:translateY(-3px)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .stat-icon{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .stat-icon.blue{background:rgba(99,102,241,0.15);color:var(--primary)}
        .stat-icon.green{background:rgba(16,185,129,0.15);color:var(--success)}
        .stat-icon.orange{background:rgba(245,158,11,0.15);color:var(--warning)}
        .stat-icon.purple{background:rgba(168,85,247,0.15);color:var(--purple)}
        .stat-value{font-size:2rem;font-weight:800}
        .stat-label{color:var(--text-secondary);font-size:0.85rem}
        
        /* Task Columns */
        .tasks-container{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
        .task-column{background:var(--bg-card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
        .column-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .column-title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:0.95rem}
        .column-count{background:var(--primary);color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:700}
        .column-body{padding:12px;min-height:300px;max-height:65vh;overflow-y:auto}
        
        /* Task Card */
        .task-card{background:var(--bg-input);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;cursor:pointer;transition:var(--transition);border:2px solid transparent}
        .task-card:hover{border-color:var(--primary);transform:translateY(-2px)}
        .task-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .task-priority{font-size:0.7rem;padding:4px 10px;border-radius:20px;font-weight:700;text-transform:uppercase}
        .priority-alta{background:rgba(239,68,68,0.2);color:var(--danger)}
        .priority-media{background:rgba(245,158,11,0.2);color:var(--warning)}
        .priority-baja{background:rgba(16,185,129,0.2);color:var(--success)}
        .task-status-badge{font-size:0.7rem;padding:4px 10px;border-radius:20px;font-weight:600;display:flex;align-items:center;gap:4px}
        .status-pendiente{background:rgba(100,116,139,0.2);color:var(--text-secondary)}
        .status-en_progreso{background:rgba(59,130,246,0.2);color:var(--info)}
        .status-pausada{background:rgba(245,158,11,0.2);color:var(--warning)}
        .status-completada{background:rgba(16,185,129,0.2);color:var(--success)}
        .active-indicator{width:6px;height:6px;background:var(--success);border-radius:50%;animation:pulse 1.5s infinite}
        .task-title{font-weight:600;font-size:0.95rem;margin-bottom:10px;line-height:1.4}
        .task-meta{display:flex;justify-content:space-between;align-items:center;font-size:0.8rem;color:var(--text-muted)}
        .task-assignee{display:flex;align-items:center;gap:6px}
        .task-assignee-avatar{width:24px;height:24px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:0.65rem;font-weight:700}
        .task-time{display:flex;align-items:center;gap:4px;color:var(--accent);font-weight:600}
        
        /* Charts */
        .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px}
        .chart-card{background:var(--bg-card);padding:20px;border-radius:var(--radius-sm);box-shadow:var(--shadow)}
        .chart-title{font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
        .chart-container{position:relative;height:280px}
        
        /* Table */
        .table-card{background:var(--bg-card);border-radius:var(--radius-sm);padding:20px;box-shadow:var(--shadow)}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:0.85rem}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        th{background:var(--bg-input);font-weight:600;font-size:0.75rem;text-transform:uppercase;color:var(--text-secondary)}
        tr:hover{background:var(--bg-card-hover)}
        
        /* Modal */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-card);border-radius:var(--radius);width:100%;max-width:550px;max-height:90vh;overflow-y:auto;animation:modalIn 0.2s ease}
        @keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--bg-card);z-index:10}
        .modal-title{font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:10px}
        .modal-close{background:var(--bg-input);border:none;width:36px;height:36px;border-radius:8px;cursor:pointer;color:var(--text-secondary);display:flex;align-items:center;justify-content:center;transition:var(--transition)}
        .modal-close:hover{background:var(--danger);color:white}
        .modal-body{padding:24px}
        .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}
        
        /* Task Type Selector */
        .task-type-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
        .task-type-option{padding:20px 16px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:var(--transition)}
        .task-type-option:hover{border-color:var(--primary)}
        .task-type-option.selected{border-color:var(--primary);background:rgba(99,102,241,0.1)}
        .task-type-option i{font-size:1.8rem;margin-bottom:10px;display:block}
        .task-type-option span{font-size:0.85rem;font-weight:600}
        .task-type-option.principal i{color:var(--warning)}
        .task-type-option.gestion i{color:var(--info)}
        .task-type-option.complementario i{color:var(--success)}
        
        /* Priority Selector */
        .priority-selector{display:flex;gap:12px;margin-bottom:20px}
        .priority-option{flex:1;padding:14px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;text-align:center;font-weight:600;font-size:0.9rem;transition:var(--transition)}
        .priority-option:hover{border-color:var(--primary)}
        .priority-option.alta.selected{border-color:var(--danger);background:rgba(239,68,68,0.1);color:var(--danger)}
        .priority-option.media.selected{border-color:var(--warning);background:rgba(245,158,11,0.1);color:var(--warning)}
        .priority-option.baja.selected{border-color:var(--success);background:rgba(16,185,129,0.1);color:var(--success)}
        
        /* Time Tracker */
        .time-tracker{background:var(--bg-input);border-radius:var(--radius-sm);padding:24px;text-align:center;margin-bottom:20px}
        .time-display{font-size:2.8rem;font-weight:800;font-family:'Courier New',monospace;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .time-status{font-size:0.9rem;color:var(--text-muted);margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px}
        .time-status.active{color:var(--success)}
        
        /* Task Detail */
        .task-detail-meta{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .meta-item{background:var(--bg-input);padding:14px;border-radius:10px}
        .meta-label{font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase}
        .meta-value{font-weight:600;font-size:0.95rem}
        .task-actions{display:flex;gap:10px;flex-wrap:wrap}
        .info-note{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:10px;padding:14px;font-size:0.85rem;color:var(--info);margin-top:16px;display:flex;align-items:center;gap:10px}
        
        /* Workers */
        .workers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
        .worker-card{background:var(--bg-card);border-radius:var(--radius-sm);padding:20px;box-shadow:var(--shadow);cursor:pointer;transition:var(--transition)}
        .worker-card:hover{transform:translateY(-3px);border:1px solid var(--primary)}
        .worker-header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
        .worker-avatar{width:50px;height:50px;background:linear-gradient(135deg,var(--primary),var(--accent));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1.3rem}
        .worker-name{font-weight:700;font-size:1rem}
        .worker-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center}
        .worker-stat{background:var(--bg-input);padding:12px;border-radius:10px}
        .worker-stat-value{font-weight:700;font-size:1.2rem}
        .worker-stat-label{font-size:0.7rem;color:var(--text-muted)}
        
        /* Toast */
        .toast-container{position:fixed;top:80px;right:24px;z-index:10001;display:flex;flex-direction:column;gap:10px}
        .toast{background:var(--bg-card);padding:16px 20px;border-radius:var(--radius-sm);display:flex;align-items:center;gap:12px;font-weight:500;animation:toastSlide 0.3s ease;box-shadow:var(--shadow-lg);border-left:4px solid;max-width:400px}
        @keyframes toastSlide{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .toast.success{border-color:var(--success)}
        .toast.error{border-color:var(--danger)}
        .toast.warning{border-color:var(--warning)}
        .toast.info{border-color:var(--info)}
        
        /* Empty State */
        .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
        .empty-state i{font-size:3rem;margin-bottom:16px;opacity:0.4}
        .empty-state p{font-size:0.95rem}
        
        /* Responsive */
        @media(max-width:1024px){
            .tasks-container{grid-template-columns:1fr}
            .charts-grid{grid-template-columns:1fr}
            .sidebar{transform:translateX(-100%)}
            .main-content{margin-left:0}
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Cargando...</div>
            <div class="loading-subtext" id="loadingSubtext"></div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- Update Banner -->
    <div class="update-banner" id="updateBanner">
        <div class="update-banner-content">
            <i class="fas fa-bell"></i>
            <span>Hay actualizaciones de otros usuarios disponibles</span>
            <button onclick="recargarDatos()"><i class="fas fa-sync-alt"></i> Actualizar Datos</button>
            <button class="close-btn" onclick="hideUpdateBanner()">√ó</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Section -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon"><i class="fas fa-bolt"></i></div>
                <h1>TaskFlow Pro</h1>
                <p style="color:var(--text-muted);margin-top:8px">Sistema de Gesti√≥n de Tareas</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthForm('login')">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="showAuthForm('register')">Registrarse</button>
            </div>
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group"><label>Correo electr√≥nico</label><input type="email" id="loginEmail" class="form-control" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="loginPassword" class="form-control" required></div>
                <button type="submit" class="btn btn-primary btn-block">Iniciar Sesi√≥n</button>
            </form>
            <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group"><label>Nombre completo</label><input type="text" id="registerName" class="form-control" required></div>
                <div class="form-group"><label>Correo electr√≥nico</label><input type="email" id="registerEmail" class="form-control" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="registerPassword" class="form-control" minlength="6" required></div>
                <div class="form-group"><label>Rol</label><select id="registerRole" class="form-control" onchange="toggleJefeCode()"><option value="trabajador">Trabajador</option><option value="jefe">Jefe</option></select></div>
                <div class="form-group" id="jefeCodeGroup" style="display:none"><label>C√≥digo de Jefe</label><input type="password" id="jefeCode" class="form-control" placeholder="C√≥digo secreto"></div>
                <button type="submit" class="btn btn-primary btn-block">Crear Cuenta</button>
            </form>
        </div>
    </div>

    <!-- App Section -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon"><i class="fas fa-bolt"></i></div>
                    <div><div class="logo-title">TaskFlow</div><div class="logo-subtitle">Sistema de Gesti√≥n</div></div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-title">Principal</div>
                <a class="nav-item active" onclick="showView('tasks')"><i class="fas fa-clipboard-list"></i> Tareas</a>
                <a class="nav-item" onclick="showView('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <div id="adminNav" style="display:none">
                    <div class="nav-section-title">Administraci√≥n</div>
                    <a class="nav-item" onclick="showView('workers')"><i class="fas fa-users-cog"></i> Trabajadores</a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="theme-toggle"><button class="theme-btn" onclick="toggleTheme()"></button><span style="font-size:0.85rem;color:var(--text-secondary)">Tema</span></div>
                <div class="sync-status" id="syncStatus">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">Conectando...</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div><div class="user-name" id="userName">Usuario</div><span class="role-badge trabajador" id="userRole">Trabajador</span></div>
                </div>
                <button class="btn btn-secondary btn-sm btn-block" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 id="headerTitle">Tareas</h1>
                    <p id="headerSubtitle">Gestiona las tareas de tu equipo</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="recargarDatos()"><i class="fas fa-sync-alt"></i> Sincronizar</button>
                    <button class="btn btn-primary" onclick="openNewTaskModal()"><i class="fas fa-plus"></i> Nueva Tarea</button>
                </div>
            </header>

            <div class="content-area">
                <!-- Vista Tareas -->
                <div class="view active" id="tasksView">
                    <div class="filters-bar">
                        <div class="filter-group"><label>Estado:</label><select class="filter-select" id="filterStatus" onchange="renderTasks()"><option value="">Todos</option><option value="pendiente">Pendiente</option><option value="en_progreso">En Progreso</option><option value="pausada">Pausada</option><option value="completada">Completada</option></select></div>
                        <div class="filter-group"><label>Prioridad:</label><select class="filter-select" id="filterPriority" onchange="renderTasks()"><option value="">Todas</option><option value="alta">Alta</option><option value="media">Media</option><option value="baja">Baja</option></select></div>
                        <div class="filter-group" id="filterWorkerGroup" style="display:none"><label>Trabajador:</label><select class="filter-select" id="filterWorker" onchange="renderTasks()"><option value="">Todos</option></select></div>
                    </div>
                    <div class="tasks-container">
                        <div class="task-column"><div class="column-header"><div class="column-title"><i class="fas fa-star" style="color:var(--warning)"></i> Principal</div><span class="column-count" id="countPrincipal">0</span></div><div class="column-body" id="columnPrincipal"></div></div>
                        <div class="task-column"><div class="column-header"><div class="column-title"><i class="fas fa-clipboard-check" style="color:var(--info)"></i> Gestiones</div><span class="column-count" id="countGestion">0</span></div><div class="column-body" id="columnGestion"></div></div>
                        <div class="task-column"><div class="column-header"><div class="column-title"><i class="fas fa-puzzle-piece" style="color:var(--success)"></i> Complementarios</div><span class="column-count" id="countComplementario">0</span></div><div class="column-body" id="columnComplementario"></div></div>
                    </div>
                </div>

                <!-- Vista Dashboard -->
                <div class="view" id="dashboardView">
                    <div class="filters-bar">
                        <div class="filter-group"><label>Per√≠odo:</label><select class="filter-select" id="dashboardPeriod" onchange="renderDashboard()"><option value="today">Hoy</option><option value="week" selected>Esta Semana</option><option value="month">Este Mes</option><option value="all">Todo</option></select></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-header"><span class="stat-label">Total Tareas</span><div class="stat-icon blue"><i class="fas fa-tasks"></i></div></div><div class="stat-value" id="statTotal">0</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-label">Completadas</span><div class="stat-icon green"><i class="fas fa-check-circle"></i></div></div><div class="stat-value" id="statCompleted">0</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-label">En Progreso</span><div class="stat-icon orange"><i class="fas fa-spinner"></i></div></div><div class="stat-value" id="statProgress">0</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-label">Efectividad</span><div class="stat-icon purple"><i class="fas fa-percentage"></i></div></div><div class="stat-value" id="statEfficiency">0%</div></div>
                    </div>
                    <div class="charts-grid">
                        <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-bar" style="color:var(--primary)"></i> Tareas por Estado</div><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
                        <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-pie" style="color:var(--success)"></i> Por Tipo</div><div class="chart-container"><canvas id="typeChart"></canvas></div></div>
                    </div>
                    <div class="table-card">
                        <div class="chart-title"><i class="fas fa-table" style="color:var(--info)"></i> Detalle de Tareas</div>
                        <div class="table-container"><table><thead><tr><th>T√≠tulo</th><th>Tipo</th><th>Estado</th><th>Asignado</th><th>Prioridad</th></tr></thead><tbody id="dashboardTable"></tbody></table></div>
                    </div>
                </div>

                <!-- Vista Trabajadores -->
                <div class="view" id="workersView">
                    <div class="stats-grid" id="workersStats"></div>
                    <div class="workers-grid" id="workersGrid"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nueva Tarea -->
    <div class="modal-overlay" id="newTaskModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title"><i class="fas fa-plus-circle"></i> Nueva Tarea</h3><button class="modal-close" onclick="closeModal('newTaskModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label>Tipo de Tarea</label>
                    <div class="task-type-selector">
                        <div class="task-type-option principal selected" onclick="selectTaskType('principal')"><i class="fas fa-star"></i><span>Principal</span></div>
                        <div class="task-type-option gestion" onclick="selectTaskType('gestion')"><i class="fas fa-clipboard-check"></i><span>Gesti√≥n</span></div>
                        <div class="task-type-option complementario" onclick="selectTaskType('complementario')"><i class="fas fa-puzzle-piece"></i><span>Complementario</span></div>
                    </div>
                </div>
                <div class="form-group"><label>Prioridad</label>
                    <div class="priority-selector">
                        <div class="priority-option alta" onclick="selectPriority('alta')">Alta</div>
                        <div class="priority-option media selected" onclick="selectPriority('media')">Media</div>
                        <div class="priority-option baja" onclick="selectPriority('baja')">Baja</div>
                    </div>
                </div>
                <div class="form-group"><label>T√≠tulo</label><input type="text" id="taskTitle" class="form-control" placeholder="¬øQu√© hay que hacer?" required></div>
                <div class="form-group"><label>Descripci√≥n (opcional)</label><textarea id="taskDescription" class="form-control" placeholder="Detalles adicionales..."></textarea></div>
                <div class="form-group"><label>Asignar a</label><select id="taskAssignee" class="form-control"></select></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newTaskModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="createTask()"><i class="fas fa-plus"></i> Crear Tarea</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Tarea -->
    <div class="modal-overlay" id="taskDetailModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title"><i class="fas fa-info-circle"></i> Detalle de Tarea</h3><button class="modal-close" onclick="closeModal('taskDetailModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="taskDetailContent"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://jzjomvfwqvedsyvfcvto.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6am9tdmZ3cXZlZHN5dmZjdnRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTA1NzAsImV4cCI6MjA3OTE2NjU3MH0.Xp_Ns363pIG46EA_pqd-9bCwBRacrVfzwdIeKYyVBP8';
        const JEFE_CODE = 'admin2024';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // VARIABLES GLOBALES (CACH√â)
        // ============================================
        let currentUser = null;
        let currentProfile = null;
        let cachedTasks = [];
        let cachedProfiles = [];
        let charts = {};
        let activeTimers = {};
        let realtimeChannel = null;
        let selectedTaskType = 'principal';
        let selectedPriority = 'media';
        let hasUpdates = false;

        // ============================================
        // UTILIDADES UI
        // ============================================
        function showLoading(text, subtext = '') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = Math.min(percent, 100) + '%';
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            toast.innerHTML = `<i class="fas fa-${icons[type]}"></i><span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function showUpdateBanner() {
            if (!hasUpdates) {
                hasUpdates = true;
                document.getElementById('updateBanner').classList.add('show');
                updateSyncStatus('warning', 'Hay actualizaciones');
            }
        }

        function hideUpdateBanner() {
            hasUpdates = false;
            document.getElementById('updateBanner').classList.remove('show');
        }

        function updateSyncStatus(status, text) {
            const dot = document.getElementById('syncDot');
            const textEl = document.getElementById('syncText');
            dot.className = 'sync-dot ' + (status === 'ok' ? '' : status);
            textEl.textContent = text;
        }

        function formatDuration(mins) {
            if (!mins) return '0m';
            const h = Math.floor(mins / 60), m = mins % 60;
            return h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        function formatStatus(s) {
            return { pendiente: 'Pendiente', en_progreso: 'En Progreso', pausada: 'Pausada', completada: 'Completada' }[s] || s;
        }

        function formatTaskType(t) {
            return { principal: 'Principal', gestion: 'Gesti√≥n', complementario: 'Complementario' }[t] || t;
        }

        // ============================================
        // TEMA
        // ============================================
        function loadTheme() {
            const theme = localStorage.getItem('taskflow-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        }
        
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('taskflow-theme', next);
        }

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        function showAuthForm(type) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(type + 'Form').classList.add('active');
        }

        function toggleJefeCode() {
            document.getElementById('jefeCodeGroup').style.display = document.getElementById('registerRole').value === 'jefe' ? 'block' : 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                });
                if (error) throw error;
            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'Iniciar Sesi√≥n';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const role = document.getElementById('registerRole').value;
            if (role === 'jefe' && document.getElementById('jefeCode').value !== JEFE_CODE) {
                showToast('C√≥digo de jefe incorrecto', 'error');
                return;
            }
            
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: document.getElementById('registerEmail').value,
                    password: document.getElementById('registerPassword').value,
                    options: { data: { full_name: document.getElementById('registerName').value, role } }
                });
                if (error) throw error;
                showToast('¬°Cuenta creada! Ya puedes iniciar sesi√≥n', 'success');
                showAuthForm('login');
            } catch (error) {
                showToast(error.message, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = 'Crear Cuenta';
        }

        async function handleLogout() {
            if (realtimeChannel) supabase.removeChannel(realtimeChannel);
            await supabase.auth.signOut();
            currentUser = null;
            currentProfile = null;
            cachedTasks = [];
            cachedProfiles = [];
        }

        // ============================================
        // CARGA DE DATOS (ESTILO MAWI)
        // ============================================
        async function cargarTodosLosRegistros(tabla, orderColumn, selectQuery = '*') {
            let allData = [];
            let from = 0;
            const batchSize = 1000;
            
            while (true) {
                const { data, error } = await supabase.from(tabla).select(selectQuery).order(orderColumn, { ascending: false }).range(from, from + batchSize - 1);
                if (error) { console.error(`Error cargando ${tabla}:`, error); break; }
                if (!data || data.length === 0) break;
                allData = allData.concat(data);
                updateProgress((allData.length / (from + batchSize * 2)) * 100);
                document.getElementById('loadingSubtext').textContent = `${tabla}: ${allData.length.toLocaleString()} registros...`;
                if (data.length < batchSize) break;
                from += batchSize;
            }
            return allData;
        }

        async function cargarDatos() {
            showLoading('Cargando datos...');
            updateSyncStatus('warning', 'Cargando...');
            
            try {
                // Cargar profiles
                document.getElementById('loadingText').textContent = 'Cargando perfiles...';
                const { data: profiles } = await supabase.from('profiles').select('*').order('full_name');
                cachedProfiles = profiles || [];
                console.log('‚úÖ Profiles cargados:', cachedProfiles.length);
                updateProgress(30);

                // Cargar tasks con relaciones
                document.getElementById('loadingText').textContent = 'Cargando tareas...';
                const { data: tasks } = await supabase.from('tasks').select(`
                    *, 
                    assigned_profile:profiles!tasks_assigned_to_fkey(id, full_name),
                    created_profile:profiles!tasks_created_by_fkey(id, full_name),
                    task_sessions(id, duration_minutes, is_active, start_time)
                `).order('created_at', { ascending: false });
                cachedTasks = tasks || [];
                console.log('‚úÖ Tasks cargadas:', cachedTasks.length);
                updateProgress(80);

                // Actualizar UI
                document.getElementById('loadingText').textContent = 'Renderizando...';
                updateProgress(100);
                
                populateFilters();
                renderTasks();
                
                hideLoading();
                hideUpdateBanner();
                updateSyncStatus('ok', 'Datos sincronizados');
                showToast(`${cachedTasks.length} tareas cargadas`, 'success');
                
            } catch (error) {
                hideLoading();
                updateSyncStatus('error', 'Error de conexi√≥n');
                showToast('Error cargando datos: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function recargarDatos() {
            await cargarDatos();
        }

        function populateFilters() {
            // Filtro trabajadores (solo para jefes)
            if (currentProfile?.role === 'jefe') {
                const select = document.getElementById('filterWorker');
                select.innerHTML = '<option value="">Todos</option>';
                cachedProfiles.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.full_name || 'Sin nombre'}</option>`;
                });
                document.getElementById('filterWorkerGroup').style.display = 'block';
            }
            
            populateAssignees();
        }

        function populateAssignees() {
            const select = document.getElementById('taskAssignee');
            select.innerHTML = '';
            
            if (cachedProfiles.length === 0) {
                select.innerHTML = '<option value="">No hay usuarios</option>';
                return;
            }
            
            cachedProfiles.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.full_name || 'Sin nombre'} (${p.role || 'trabajador'})`;
                if (currentUser && p.id === currentUser.id) option.selected = true;
                select.appendChild(option);
            });
        }

        // ============================================
        // RENDERIZAR TAREAS
        // ============================================
        function renderTasks() {
            const statusFilter = document.getElementById('filterStatus').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const workerFilter = document.getElementById('filterWorker')?.value;
            
            let filtered = [...cachedTasks];
            
            if (statusFilter) filtered = filtered.filter(t => t.status === statusFilter);
            if (priorityFilter) filtered = filtered.filter(t => t.priority === priorityFilter);
            if (workerFilter) filtered = filtered.filter(t => t.assigned_to === workerFilter);
            
            const columns = {
                principal: document.getElementById('columnPrincipal'),
                gestion: document.getElementById('columnGestion'),
                complementario: document.getElementById('columnComplementario')
            };
            const counts = { principal: 0, gestion: 0, complementario: 0 };
            
            Object.values(columns).forEach(c => c.innerHTML = '');
            
            if (filtered.length === 0) {
                Object.values(columns).forEach(c => {
                    c.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay tareas</p></div>';
                });
            } else {
                filtered.forEach(task => {
                    const col = columns[task.task_type];
                    if (!col) return;
                    counts[task.task_type]++;
                    
                    const sessions = task.task_sessions || [];
                    const totalMins = sessions.filter(s => !s.is_active).reduce((sum, s) => sum + (s.duration_minutes || 0), 0);
                    const hasActive = sessions.some(s => s.is_active);
                    const assignee = task.assigned_profile?.full_name || 'Sin asignar';
                    
                    col.innerHTML += `
                        <div class="task-card" onclick='openTaskDetail(${JSON.stringify(task).replace(/'/g, "\\'")})'>
                            <div class="task-card-header">
                                <span class="task-priority priority-${task.priority}">${task.priority}</span>
                                <span class="task-status-badge status-${task.status}">${hasActive ? '<span class="active-indicator"></span>' : ''}${formatStatus(task.status)}</span>
                            </div>
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                <div class="task-assignee"><div class="task-assignee-avatar">${assignee.charAt(0).toUpperCase()}</div><span>${assignee}</span></div>
                                ${totalMins > 0 ? `<span class="task-time"><i class="fas fa-clock"></i> ${formatDuration(totalMins)}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                Object.keys(columns).forEach(type => {
                    if (counts[type] === 0) {
                        columns[type].innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay tareas</p></div>';
                    }
                });
            }
            
            document.getElementById('countPrincipal').textContent = counts.principal;
            document.getElementById('countGestion').textContent = counts.gestion;
            document.getElementById('countComplementario').textContent = counts.complementario;
        }

        // ============================================
        // MODAL NUEVA TAREA
        // ============================================
        function selectTaskType(type) {
            selectedTaskType = type;
            document.querySelectorAll('.task-type-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.task-type-option.${type}`).classList.add('selected');
        }

        function selectPriority(priority) {
            selectedPriority = priority;
            document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.priority-option.${priority}`).classList.add('selected');
        }

        function openNewTaskModal() {
            if (selectedTaskType === 'principal' && currentProfile?.role !== 'jefe') {
                selectTaskType('gestion');
            }
            populateAssignees();
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('newTaskModal').classList.add('active');
        }

        async function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) { showToast('El t√≠tulo es obligatorio', 'error'); return; }
            
            if (selectedTaskType === 'principal' && currentProfile?.role !== 'jefe') {
                showToast('Solo el jefe puede crear tareas principales', 'error');
                return;
            }
            
            const assignee = document.getElementById('taskAssignee').value;
            if (!assignee) { showToast('Selecciona un asignado', 'error'); return; }
            
            showLoading('Creando tarea...');
            try {
                const { data, error } = await supabase.from('tasks').insert([{
                    title,
                    description: document.getElementById('taskDescription').value.trim(),
                    task_type: selectedTaskType,
                    priority: selectedPriority,
                    assigned_to: assignee,
                    created_by: currentUser.id,
                    status: 'pendiente'
                }]).select(`*, assigned_profile:profiles!tasks_assigned_to_fkey(id, full_name), created_profile:profiles!tasks_created_by_fkey(id, full_name), task_sessions(id, duration_minutes, is_active, start_time)`).single();
                
                if (error) throw error;
                
                cachedTasks.unshift(data);
                renderTasks();
                
                hideLoading();
                closeModal('newTaskModal');
                showToast('Tarea creada correctamente', 'success');
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        }

        // ============================================
        // DETALLE TAREA
        // ============================================
        function openTaskDetail(task) {
            const sessions = task.task_sessions || [];
            const activeSession = sessions.find(s => s.is_active);
            const totalMins = sessions.filter(s => !s.is_active).reduce((sum, s) => sum + (s.duration_minutes || 0), 0);
            const isOwner = task.assigned_to === currentUser?.id;
            const isJefe = currentProfile?.role === 'jefe';
            const canControl = isOwner || isJefe;
            
            let actions = '';
            if (task.status !== 'completada') {
                if (!activeSession && (task.status === 'pendiente' || task.status === 'pausada')) {
                    actions += `<button class="btn btn-success btn-sm" onclick="startTask('${task.id}')" ${!canControl ? 'disabled' : ''}><i class="fas fa-play"></i> ${task.status === 'pausada' ? 'Reanudar' : 'Iniciar'}</button>`;
                }
                if (activeSession) {
                    actions += `<button class="btn btn-warning btn-sm" onclick="pauseTask('${task.id}')" ${!isJefe ? 'disabled' : ''}><i class="fas fa-pause"></i> Pausar</button>`;
                    actions += `<button class="btn btn-success btn-sm" onclick="completeTask('${task.id}')" ${!isJefe ? 'disabled' : ''}><i class="fas fa-check"></i> Completar</button>`;
                }
            }
            if (isJefe) actions += `<button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')"><i class="fas fa-trash"></i> Eliminar</button>`;
            
            document.getElementById('taskDetailContent').innerHTML = `
                <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
                    <span class="task-priority priority-${task.priority}">${task.priority}</span>
                    <span class="task-status-badge status-${task.status}">${activeSession ? '<span class="active-indicator"></span>' : ''}${formatStatus(task.status)}</span>
                </div>
                <h2 style="font-size:1.4rem;font-weight:700;margin-bottom:12px">${task.title}</h2>
                ${task.description ? `<p style="color:var(--text-secondary);margin-bottom:20px">${task.description}</p>` : ''}
                <div class="time-tracker">
                    <div class="time-display" id="timerDisplay">${formatDuration(totalMins)}</div>
                    ${activeSession ? `<div class="time-status active"><span class="active-indicator"></span>En progreso</div>` : '<div class="time-status">Tiempo acumulado</div>'}
                </div>
                <div class="task-detail-meta">
                    <div class="meta-item"><div class="meta-label">Tipo</div><div class="meta-value">${formatTaskType(task.task_type)}</div></div>
                    <div class="meta-item"><div class="meta-label">Asignado</div><div class="meta-value">${task.assigned_profile?.full_name || 'N/A'}</div></div>
                    <div class="meta-item"><div class="meta-label">Creado por</div><div class="meta-value">${task.created_profile?.full_name || 'N/A'}</div></div>
                    <div class="meta-item"><div class="meta-label">Fecha</div><div class="meta-value">${new Date(task.created_at).toLocaleDateString('es-ES')}</div></div>
                </div>
                <div class="task-actions">${actions}</div>
                ${!isJefe && activeSession ? '<div class="info-note"><i class="fas fa-info-circle"></i>Solo el jefe puede pausar/completar tareas</div>' : ''}
            `;
            
            document.getElementById('taskDetailModal').classList.add('active');
            
            if (activeSession) {
                const startDate = new Date(activeSession.start_time);
                if (activeTimers.detail) clearInterval(activeTimers.detail);
                activeTimers.detail = setInterval(() => {
                    const elapsed = Math.floor((new Date() - startDate) / 60000);
                    document.getElementById('timerDisplay').textContent = formatDuration(totalMins + elapsed);
                }, 1000);
            }
        }

        // ============================================
        // ACCIONES TAREA
        // ============================================
        async function startTask(taskId) {
            showLoading('Iniciando tarea...');
            try {
                await supabase.from('task_sessions').insert([{ task_id: taskId, user_id: currentUser.id, start_time: new Date().toISOString(), is_active: true }]);
                await supabase.from('tasks').update({ status: 'en_progreso' }).eq('id', taskId);
                hideLoading();
                showToast('Tarea iniciada', 'success');
                closeModal('taskDetailModal');
                await cargarDatos();
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function pauseTask(taskId) {
            showLoading('Pausando tarea...');
            try {
                const { data: session } = await supabase.from('task_sessions').select('*').eq('task_id', taskId).eq('is_active', true).single();
                if (session) {
                    const duration = Math.floor((new Date() - new Date(session.start_time)) / 60000);
                    await supabase.from('task_sessions').update({ is_active: false, duration_minutes: duration, end_time: new Date().toISOString() }).eq('id', session.id);
                }
                await supabase.from('tasks').update({ status: 'pausada' }).eq('id', taskId);
                hideLoading();
                showToast('Tarea pausada', 'success');
                closeModal('taskDetailModal');
                await cargarDatos();
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function completeTask(taskId) {
            showLoading('Completando tarea...');
            try {
                const { data: session } = await supabase.from('task_sessions').select('*').eq('task_id', taskId).eq('is_active', true).single();
                if (session) {
                    const duration = Math.floor((new Date() - new Date(session.start_time)) / 60000);
                    await supabase.from('task_sessions').update({ is_active: false, duration_minutes: duration, end_time: new Date().toISOString() }).eq('id', session.id);
                }
                await supabase.from('tasks').update({ status: 'completada' }).eq('id', taskId);
                hideLoading();
                showToast('¬°Tarea completada!', 'success');
                closeModal('taskDetailModal');
                await cargarDatos();
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('¬øEliminar esta tarea?')) return;
            showLoading('Eliminando...');
            try {
                await supabase.from('task_sessions').delete().eq('task_id', taskId);
                await supabase.from('tasks').delete().eq('id', taskId);
                hideLoading();
                showToast('Tarea eliminada', 'success');
                closeModal('taskDetailModal');
                cachedTasks = cachedTasks.filter(t => t.id !== taskId);
                renderTasks();
            } catch (error) {
                hideLoading();
                showToast('Error: ' + error.message, 'error');
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function renderDashboard() {
            const period = document.getElementById('dashboardPeriod').value;
            const now = new Date();
            let filtered = [...cachedTasks];
            
            if (period === 'today') {
                filtered = filtered.filter(t => new Date(t.created_at).toDateString() === now.toDateString());
            } else if (period === 'week') {
                const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                filtered = filtered.filter(t => new Date(t.created_at) >= weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                filtered = filtered.filter(t => new Date(t.created_at) >= monthAgo);
            }
            
            const total = filtered.length;
            const completed = filtered.filter(t => t.status === 'completada').length;
            const inProgress = filtered.filter(t => t.status === 'en_progreso').length;
            const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statProgress').textContent = inProgress;
            document.getElementById('statEfficiency').textContent = efficiency + '%';
            
            // Status Chart
            const statusCounts = {
                pendiente: filtered.filter(t => t.status === 'pendiente').length,
                en_progreso: inProgress,
                pausada: filtered.filter(t => t.status === 'pausada').length,
                completada: completed
            };
            
            if (charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'bar',
                data: {
                    labels: ['Pendiente', 'En Progreso', 'Pausada', 'Completada'],
                    datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#64748b', '#3b82f6', '#f59e0b', '#10b981'], borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            
            // Type Chart
            const typeCounts = {
                principal: filtered.filter(t => t.task_type === 'principal').length,
                gestion: filtered.filter(t => t.task_type === 'gestion').length,
                complementario: filtered.filter(t => t.task_type === 'complementario').length
            };
            
            if (charts.type) charts.type.destroy();
            charts.type = new Chart(document.getElementById('typeChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Principal', 'Gesti√≥n', 'Complementario'],
                    datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            
            // Table
            document.getElementById('dashboardTable').innerHTML = filtered.slice(0, 10).map(t => `
                <tr>
                    <td>${t.title}</td>
                    <td>${formatTaskType(t.task_type)}</td>
                    <td><span class="task-status-badge status-${t.status}">${formatStatus(t.status)}</span></td>
                    <td>${t.assigned_profile?.full_name || 'N/A'}</td>
                    <td><span class="task-priority priority-${t.priority}">${t.priority}</span></td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text-muted)">No hay datos</td></tr>';
        }

        // ============================================
        // TRABAJADORES
        // ============================================
        function renderWorkers() {
            const workersStats = cachedProfiles.map(worker => {
                const tasks = cachedTasks.filter(t => t.assigned_to === worker.id);
                const completed = tasks.filter(t => t.status === 'completada').length;
                const totalMins = tasks.reduce((sum, t) => sum + (t.task_sessions || []).filter(s => !s.is_active).reduce((s, sess) => s + (sess.duration_minutes || 0), 0), 0);
                return { ...worker, tasks: tasks.length, completed, totalMins, efficiency: tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0 };
            });
            
            document.getElementById('workersStats').innerHTML = `
                <div class="stat-card"><div class="stat-header"><span class="stat-label">Total Trabajadores</span><div class="stat-icon blue"><i class="fas fa-users"></i></div></div><div class="stat-value">${workersStats.length}</div></div>
                <div class="stat-card"><div class="stat-header"><span class="stat-label">Activos</span><div class="stat-icon green"><i class="fas fa-user-check"></i></div></div><div class="stat-value">${workersStats.filter(w => w.tasks > 0).length}</div></div>
                <div class="stat-card"><div class="stat-header"><span class="stat-label">Efectividad Promedio</span><div class="stat-icon purple"><i class="fas fa-chart-line"></i></div></div><div class="stat-value">${Math.round(workersStats.reduce((s, w) => s + w.efficiency, 0) / workersStats.length || 0)}%</div></div>
            `;
            
            document.getElementById('workersGrid').innerHTML = workersStats.map(w => `
                <div class="worker-card" onclick="filterByWorker('${w.id}')">
                    <div class="worker-header">
                        <div class="worker-avatar">${(w.full_name || 'U').charAt(0).toUpperCase()}</div>
                        <div><div class="worker-name">${w.full_name || 'Usuario'}</div><span class="role-badge ${w.role}">${w.role}</span></div>
                    </div>
                    <div class="worker-stats">
                        <div class="worker-stat"><div class="worker-stat-value">${w.tasks}</div><div class="worker-stat-label">Tareas</div></div>
                        <div class="worker-stat"><div class="worker-stat-value">${w.completed}</div><div class="worker-stat-label">Completadas</div></div>
                        <div class="worker-stat"><div class="worker-stat-value" style="color:${w.efficiency >= 70 ? 'var(--success)' : w.efficiency >= 40 ? 'var(--warning)' : 'var(--danger)'}">${w.efficiency}%</div><div class="worker-stat-label">Efectividad</div></div>
                    </div>
                </div>
            `).join('') || '<div class="empty-state"><i class="fas fa-users"></i><p>No hay trabajadores</p></div>';
        }

        function filterByWorker(workerId) {
            document.getElementById('filterWorker').value = workerId;
            showView('tasks');
            renderTasks();
        }

        // ============================================
        // VISTAS Y MODALES
        // ============================================
        function showView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
            event?.target?.classList.add('active');
            
            const titles = { tasks: ['Tareas', 'Gestiona las tareas de tu equipo'], dashboard: ['Dashboard', 'M√©tricas y estad√≠sticas'], workers: ['Trabajadores', 'Rendimiento del equipo'] };
            document.getElementById('headerTitle').textContent = titles[view]?.[0] || 'TaskFlow';
            document.getElementById('headerSubtitle').textContent = titles[view]?.[1] || '';
            
            if (view === 'dashboard') renderDashboard();
            if (view === 'workers') renderWorkers();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            Object.values(activeTimers).forEach(t => clearInterval(t));
            activeTimers = {};
        }

        // ============================================
        // REALTIME (SOLO NOTIFICA, NO AUTO-REFRESH)
        // ============================================
        function setupRealtime() {
            realtimeChannel = supabase.channel('taskflow-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
                    console.log('üì¢ Cambio detectado en tasks:', payload.eventType);
                    showUpdateBanner();
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'task_sessions' }, (payload) => {
                    console.log('üì¢ Cambio detectado en task_sessions:', payload.eventType);
                    showUpdateBanner();
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, (payload) => {
                    console.log('üì¢ Cambio detectado en profiles:', payload.eventType);
                    showUpdateBanner();
                })
                .subscribe((status) => {
                    console.log('Realtime status:', status);
                    if (status === 'SUBSCRIBED') {
                        updateSyncStatus('ok', 'Conectado en tiempo real');
                    } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                        updateSyncStatus('error', 'Desconectado');
                    }
                });
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        async function initApp() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                
                // Obtener o crear perfil
                let { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                
                if (!profile) {
                    const { data: newProfile } = await supabase.from('profiles').insert([{
                        id: currentUser.id,
                        full_name: currentUser.user_metadata?.full_name || 'Usuario',
                        role: currentUser.user_metadata?.role || 'trabajador'
                    }]).select().single();
                    profile = newProfile;
                }
                
                currentProfile = profile;
                
                // Mostrar app
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                
                // UI Usuario
                document.getElementById('userAvatar').textContent = (profile?.full_name || 'U').charAt(0).toUpperCase();
                document.getElementById('userName').textContent = profile?.full_name || 'Usuario';
                document.getElementById('userRole').textContent = profile?.role || 'trabajador';
                document.getElementById('userRole').className = `role-badge ${profile?.role || 'trabajador'}`;
                
                if (profile?.role === 'jefe') {
                    document.getElementById('adminNav').style.display = 'block';
                }
                
                // Cargar datos
                await cargarDatos();
                
                // Configurar realtime
                setupRealtime();
            }
        }

        // Auth listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                initApp();
            } else if (event === 'SIGNED_OUT') {
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        // Modal click outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
                Object.values(activeTimers).forEach(t => clearInterval(t));
                activeTimers = {};
            }
        });

        // Init
        loadTheme();
        initApp();
        
        console.log('‚úÖ TaskFlow Pro v2.0 - Sistema con cach√© y notificaciones');
    </script>
</body>
</html>
