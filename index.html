<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro - Sistema de Gestión</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7c3aed; --primary-dark: #6d28d9; --primary-light: #a78bfa;
            --primary-glow: rgba(124, 58, 237, 0.4);
            --accent: #06b6d4; --accent-light: #22d3ee;
            --success: #10b981; --success-light: #34d399;
            --danger: #ef4444; --danger-light: #f87171;
            --warning: #f59e0b; --warning-light: #fbbf24;
            --info: #3b82f6;
            --bg-main: #0a0a0f; --bg-card: #141419; --bg-card-hover: #1a1a22;
            --bg-input: #1e1e28; --bg-glass: rgba(20, 20, 25, 0.8);
            --text-primary: #f8fafc; --text-secondary: #a1a1aa; --text-muted: #71717a;
            --border: rgba(255, 255, 255, 0.08);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --radius: 16px; --radius-sm: 10px; --radius-xs: 6px;
            --sidebar-width: 280px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        [data-theme="light"] {
            --bg-main: #f4f4f8; --bg-card: #ffffff; --bg-card-hover: #f8f8fc;
            --bg-input: #f1f1f5; --bg-glass: rgba(255, 255, 255, 0.9);
            --text-primary: #18181b; --text-secondary: #52525b; --text-muted: #a1a1aa;
            --border: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main); color: var(--text-primary);
            line-height: 1.6; min-height: 100vh;
        }
        .bg-gradient {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
        }
        .bg-gradient::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(ellipse at 30% 20%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }
        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(2%, 2%); }
        }
        .auth-container {
            min-height: 100vh; display: flex; align-items: center;
            justify-content: center; padding: 20px;
        }
        .auth-box {
            background: var(--bg-glass); backdrop-filter: blur(20px);
            padding: 48px; border-radius: 24px; width: 100%; max-width: 440px;
            border: 1px solid var(--border); box-shadow: var(--shadow-lg);
            position: relative;
        }
        .auth-box::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 3px; background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 24px 24px 0 0;
        }
        .auth-logo { text-align: center; margin-bottom: 40px; }
        .auth-logo h1 {
            font-size: 2.2rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 8px;
        }
        .auth-logo p { color: var(--text-muted); font-size: 0.95rem; }
        .auth-tabs {
            display: flex; gap: 8px; margin-bottom: 32px;
            background: var(--bg-input); padding: 6px; border-radius: var(--radius-sm);
        }
        .auth-tab {
            flex: 1; padding: 12px 20px; border: none; background: transparent;
            color: var(--text-muted); border-radius: var(--radius-xs); cursor: pointer;
            font-weight: 600; font-size: 0.9rem; transition: var(--transition); font-family: inherit;
        }
        .auth-tab:hover { color: var(--text-primary); }
        .auth-tab.active {
            background: var(--primary); color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }
        .form-group { margin-bottom: 24px; }
        .form-group label {
            display: block; margin-bottom: 10px; font-size: 0.875rem;
            font-weight: 500; color: var(--text-secondary);
        }
        .form-control {
            width: 100%; padding: 14px 18px; border: 2px solid var(--border);
            border-radius: var(--radius-sm); background: var(--bg-input);
            color: var(--text-primary); font-size: 0.95rem; font-family: inherit;
            transition: var(--transition);
        }
        .form-control:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }
        .form-control::placeholder { color: var(--text-muted); }
        select.form-control {
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center;
            background-size: 18px; padding-right: 44px;
        }
        textarea.form-control { resize: vertical; min-height: 100px; }
        .btn {
            padding: 14px 28px; border: none; border-radius: var(--radius-sm);
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            transition: var(--transition); display: inline-flex;
            align-items: center; justify-content: center; gap: 10px;
            font-family: inherit; text-decoration: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 16px var(--primary-glow);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--primary-glow);
        }
        .btn-secondary {
            background: var(--bg-input); color: var(--text-primary);
            border: 2px solid var(--border);
        }
        .btn-secondary:hover { border-color: var(--primary); background: var(--bg-card-hover); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-success:hover { transform: translateY(-2px); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .btn-danger:hover { transform: translateY(-2px); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .btn-warning:hover { transform: translateY(-2px); }
        .btn-sm { padding: 10px 18px; font-size: 0.85rem; }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .app-container { display: none; min-height: 100vh; }
        .sidebar {
            position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh;
            background: var(--bg-glass); backdrop-filter: blur(20px);
            border-right: 1px solid var(--border); padding: 24px;
            display: flex; flex-direction: column; z-index: 100; transition: var(--transition);
        }
        .sidebar-logo { padding: 8px 0 32px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
        .sidebar-logo h2 {
            font-size: 1.6rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; display: flex; align-items: center; gap: 12px;
        }
        .sidebar-nav { flex: 1; overflow-y: auto; }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title {
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-muted);
            margin-bottom: 12px; padding-left: 16px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 14px; padding: 14px 18px;
            border-radius: var(--radius-sm); color: var(--text-secondary);
            text-decoration: none; margin-bottom: 6px; cursor: pointer;
            transition: var(--transition); position: relative; overflow: hidden;
        }
        .nav-item::before {
            content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 0;
            background: linear-gradient(90deg, var(--primary-glow), transparent);
            transition: var(--transition);
        }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .nav-item:hover::before { width: 100%; }
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 16px var(--primary-glow);
        }
        .nav-item.active::before { display: none; }
        .nav-item i { width: 22px; text-align: center; font-size: 1.1rem; position: relative; z-index: 1; }
        .nav-item span { font-weight: 500; position: relative; z-index: 1; }
        .sidebar-user { padding-top: 24px; border-top: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 14px; padding: 12px 0; }
        .user-avatar {
            width: 48px; height: 48px; border-radius: 14px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.1rem; color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }
        .user-details { flex: 1; min-width: 0; }
        .user-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .role-badge {
            display: inline-block; padding: 2px 10px; border-radius: 20px;
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .role-badge.jefe { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .role-badge.trabajador { background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border); }
        .theme-toggle { display: flex; align-items: center; gap: 12px; padding: 12px 0; margin-bottom: 12px; }
        .theme-toggle-btn {
            position: relative; width: 52px; height: 28px; background: var(--bg-input);
            border-radius: 14px; border: 2px solid var(--border); cursor: pointer;
            transition: var(--transition);
        }
        .theme-toggle-btn::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 18px; height: 18px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%; transition: var(--transition);
            box-shadow: 0 2px 8px var(--primary-glow);
        }
        [data-theme="light"] .theme-toggle-btn::after { transform: translateX(24px); }
        .theme-toggle-label { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
        .update-section { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .update-btn {
            width: 100%; padding: 12px 16px; background: var(--bg-input);
            border: 2px solid var(--border); border-radius: var(--radius-sm);
            color: var(--text-primary); font-size: 0.9rem; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; transition: var(--transition); position: relative; font-family: inherit;
        }
        .update-btn:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 16px var(--primary-glow);
        }
        .update-btn.loading i { animation: spin 1s linear infinite; }
        .update-btn.has-updates { border-color: var(--accent); animation: glowPulse 2s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 5px var(--accent); }
            50% { box-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent); }
        }
        .update-badge {
            position: absolute; top: -8px; right: -8px; min-width: 22px; height: 22px;
            background: linear-gradient(135deg, var(--danger), #dc2626); color: white;
            border-radius: 11px; font-size: 0.7rem; font-weight: 800;
            display: flex; align-items: center; justify-content: center; padding: 0 6px;
            animation: bounce 0.6s ease infinite; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .update-info { margin-top: 10px; text-align: center; }
        .update-time { display: block; font-size: 0.75rem; color: var(--text-muted); }
        .update-status { display: block; font-size: 0.7rem; margin-top: 4px; font-weight: 600; }
        .update-status.synced { color: var(--success); }
        .update-status.has-changes { color: var(--accent); animation: pulse 1.5s ease infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .main-content { margin-left: var(--sidebar-width); padding: 32px 40px; min-height: 100vh; }
        .page-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 32px; flex-wrap: wrap; gap: 20px;
        }
        .page-title h1 {
            font-size: 2rem; font-weight: 800; margin-bottom: 6px;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .page-title p { color: var(--text-muted); font-size: 0.95rem; }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card {
            background: var(--bg-card); padding: 28px; border-radius: var(--radius);
            border: 1px solid var(--border); transition: var(--transition);
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            opacity: 0; transition: var(--transition);
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .stat-card:hover::before { opacity: 1; }
        .stat-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 18px; }
        .stat-card-title { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card-icon { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-card-icon.primary { background: rgba(124, 58, 237, 0.15); color: var(--primary); }
        .stat-card-icon.success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .stat-card-icon.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .stat-card-icon.info { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .stat-card-value {
            font-size: 2.4rem; font-weight: 800; margin-bottom: 6px;
            background: linear-gradient(135deg, var(--text-primary), var(--primary-light));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .stat-card-change { font-size: 0.8rem; color: var(--text-muted); }
        .filters-bar {
            display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;
            padding: 20px 24px; background: var(--bg-card);
            border-radius: var(--radius); border: 1px solid var(--border); align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-group label { font-size: 0.85rem; font-weight: 500; color: var(--text-muted); white-space: nowrap; }
        .filter-select {
            padding: 10px 40px 10px 14px; border: 2px solid var(--border);
            border-radius: var(--radius-xs); background: var(--bg-input);
            color: var(--text-primary); font-size: 0.85rem; cursor: pointer;
            font-family: inherit; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center;
            background-size: 16px; transition: var(--transition);
        }
        .filter-select:focus { outline: none; border-color: var(--primary); }
        .tasks-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .task-column {
            background: var(--bg-card); border-radius: var(--radius);
            border: 1px solid var(--border); overflow: hidden;
            min-height: 500px; display: flex; flex-direction: column;
        }
        .column-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card-hover);
        }
        .column-title { font-weight: 700; display: flex; align-items: center; gap: 12px; font-size: 0.95rem; }
        .column-count {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 4px 12px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 700; min-width: 28px; text-align: center;
        }
        .column-body { padding: 16px; flex: 1; overflow-y: auto; max-height: calc(100vh - 380px); }
        .task-card {
            background: var(--bg-main); border-radius: var(--radius-sm);
            padding: 20px; margin-bottom: 14px; cursor: pointer;
            transition: var(--transition); border: 2px solid transparent;
            position: relative; overflow: hidden;
        }
        .task-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 3px; height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--accent));
            opacity: 0; transition: var(--transition);
        }
        .task-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .task-card:hover::before { opacity: 1; }
        .task-card:last-child { margin-bottom: 0; }
        .task-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 10px; }
        .task-priority { padding: 4px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .priority-alta { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .priority-media { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .priority-baja { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .task-title { font-weight: 600; margin-bottom: 12px; font-size: 0.95rem; line-height: 1.4; }
        .task-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted); gap: 10px; }
        .task-assignee { display: flex; align-items: center; gap: 8px; min-width: 0; }
        .task-assignee-avatar {
            width: 26px; height: 26px; border-radius: 8px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 700; color: white; flex-shrink: 0;
        }
        .task-assignee span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-time { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--bg-card); border-radius: 20px; font-weight: 500; flex-shrink: 0; }
        .task-status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .status-pendiente { background: rgba(100, 116, 139, 0.15); color: var(--text-secondary); }
        .status-en_progreso { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .status-pausada { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status-completada { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .active-indicator { width: 6px; height: 6px; background: currentColor; border-radius: 50%; animation: blink 1s ease infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .chart-title { font-weight: 700; font-size: 1.05rem; }
        .chart-container { position: relative; height: 300px; }
        .workers-list { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        .worker-item { display: flex; align-items: center; gap: 18px; padding: 20px 24px; border-bottom: 1px solid var(--border); cursor: pointer; transition: var(--transition); }
        .worker-item:hover { background: var(--bg-card-hover); }
        .worker-item:last-child { border-bottom: none; }
        .worker-avatar { width: 52px; height: 52px; border-radius: 14px; background: linear-gradient(135deg, var(--primary), var(--accent)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: white; flex-shrink: 0; }
        .worker-info { flex: 1; min-width: 0; }
        .worker-name { font-weight: 600; margin-bottom: 4px; }
        .worker-stats { font-size: 0.8rem; color: var(--text-muted); }
        .worker-efficiency { text-align: right; }
        .efficiency-value { font-size: 1.5rem; font-weight: 800; }
        .efficiency-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: var(--radius); width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); box-shadow: var(--shadow-lg); animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { transform: translateY(-30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-header { padding: 24px 28px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card-hover); }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .modal-close { background: var(--bg-input); border: none; color: var(--text-secondary); width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 28px; }
        .modal-footer { padding: 20px 28px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; background: var(--bg-card-hover); }
        .time-tracker { background: var(--bg-main); border-radius: var(--radius); padding: 32px; text-align: center; margin-bottom: 24px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .time-tracker::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .time-display { font-size: 3.5rem; font-weight: 800; font-family: 'Inter', monospace; background: linear-gradient(135deg, var(--primary-light), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 12px; letter-spacing: 2px; }
        .time-status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .time-status.active { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .time-status.paused { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .time-status-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: blink 1s ease infinite; }
        .task-detail-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        .meta-item { padding: 18px; background: var(--bg-main); border-radius: var(--radius-sm); border: 1px solid var(--border); }
        .meta-label { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-value { font-weight: 600; font-size: 0.95rem; }
        .task-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .task-actions .btn { flex: 1; min-width: 120px; }
        .info-note { margin-top: 20px; padding: 14px 18px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--info); display: flex; align-items: center; gap: 10px; }
        .toast-container { position: fixed; top: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: var(--bg-card); padding: 18px 24px; border-radius: var(--radius-sm); border: 1px solid var(--border); box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 14px; animation: toastSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-width: 400px; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast i { font-size: 1.2rem; flex-shrink: 0; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        @keyframes toastSlide { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        .empty-state i { font-size: 3.5rem; margin-bottom: 18px; opacity: 0.3; }
        .empty-state p { font-size: 0.95rem; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 48px; flex-direction: column; gap: 16px; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-text { font-size: 0.9rem; color: var(--text-muted); }
        .view { display: none; }
        .view.active { display: block; }
        .connection-status { position: fixed; bottom: 24px; right: 24px; padding: 10px 18px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; font-size: 0.8rem; font-weight: 500; z-index: 50; box-shadow: var(--shadow-sm); transition: var(--transition); }
        .connection-status.connected { border-color: var(--success); }
        .connection-status.disconnected { border-color: var(--danger); }
        .connection-dot { width: 8px; height: 8px; border-radius: 50%; }
        .connection-status.connected .connection-dot { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .connection-status.disconnected .connection-dot { background: var(--danger); animation: blink 1s ease infinite; }
        .jefe-code-group { display: none; }
        .jefe-code-group.show { display: block; }
        @media (max-width: 1400px) { .tasks-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1200px) { .tasks-container { grid-template-columns: 1fr; } .dashboard-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main-content { margin-left: 0; padding: 20px; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .page-header { flex-direction: column; align-items: stretch; } .header-actions { justify-content: stretch; } .header-actions .btn { flex: 1; } .filters-bar { flex-direction: column; align-items: stretch; } .filter-group { width: 100%; } .filter-select { width: 100%; } }
        @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } .task-detail-meta { grid-template-columns: 1fr; } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th, .data-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: var(--bg-card-hover); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); position: sticky; top: 0; z-index: 1; }
        .data-table tbody tr { transition: var(--transition); }
        .data-table tbody tr:hover { background: var(--bg-card-hover); }
        .data-table tfoot { background: var(--bg-card-hover); font-weight: 600; }
        .data-table tfoot td { border-top: 2px solid var(--primary); padding: 16px; }
        .table-container { max-height: 400px; overflow-y: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); }
        .jornada-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .jornada-low { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .jornada-medium { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .jornada-high { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .summary-row { display: flex; gap: 24px; justify-content: flex-end; flex-wrap: wrap; }
        .summary-item { display: flex; align-items: center; gap: 8px; }
        .summary-label { font-size: 0.8rem; color: var(--text-muted); }
        .summary-value { font-weight: 700; color: var(--text-primary); }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo"><h1><i class="fas fa-bolt"></i> TaskFlow Pro</h1><p>Sistema de Gestión Inteligente</p></div>
            <div class="auth-tabs"><button class="auth-tab active" onclick="showAuthTab('login')">Iniciar Sesión</button><button class="auth-tab" onclick="showAuthTab('register')">Registrarse</button></div>
            <form id="loginForm" onsubmit="handleLogin(event)"><div class="form-group"><label>Correo electrónico</label><input type="email" id="loginEmail" class="form-control" placeholder="ejemplo@correo.com" required></div><div class="form-group"><label>Contraseña</label><input type="password" id="loginPassword" class="form-control" placeholder="••••••••" required></div><button type="submit" class="btn btn-primary btn-block"><i class="fas fa-arrow-right"></i> Iniciar Sesión</button></form>
            <form id="registerForm" style="display:none" onsubmit="handleRegister(event)"><div class="form-group"><label>Nombre completo</label><input type="text" id="registerName" class="form-control" placeholder="Tu nombre completo" required></div><div class="form-group"><label>Correo electrónico</label><input type="email" id="registerEmail" class="form-control" placeholder="ejemplo@correo.com" required></div><div class="form-group"><label>Contraseña</label><input type="password" id="registerPassword" class="form-control" placeholder="Mínimo 6 caracteres" required minlength="6"></div><div class="form-group"><label>Rol</label><select id="registerRole" class="form-control" required onchange="toggleJefeCode()"><option value="trabajador">Trabajador</option><option value="jefe">Jefe (requiere código)</option></select></div><div class="form-group jefe-code-group" id="jefeCodeGroup"><label>Código de Jefe</label><input type="password" id="jefeCode" class="form-control" placeholder="Código secreto de administrador"></div><button type="submit" class="btn btn-primary btn-block"><i class="fas fa-user-plus"></i> Crear Cuenta</button></form>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <aside class="sidebar">
            <div class="sidebar-logo"><h2><i class="fas fa-bolt"></i> TaskFlow</h2></div>
            <nav class="sidebar-nav"><div class="nav-section"><div class="nav-section-title">Principal</div><a class="nav-item active" onclick="showView('tasks')"><i class="fas fa-clipboard-list"></i><span>Tareas</span></a><a class="nav-item" onclick="showView('dashboard')"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a></div><div class="nav-section" id="navWorkersSection" style="display:none"><div class="nav-section-title">Administración</div><a class="nav-item" onclick="showView('workers')"><i class="fas fa-users-cog"></i><span>Trabajadores</span></a></div></nav>
            <div class="sidebar-user">
                <div class="theme-toggle"><button class="theme-toggle-btn" onclick="toggleTheme()"></button><span class="theme-toggle-label" id="themeLabel">Modo Oscuro</span></div>
                <div class="update-section"><button class="update-btn" onclick="manualRefresh()" id="updateBtn"><i class="fas fa-sync-alt"></i><span>Actualizar</span><span class="update-badge" id="updateBadge" style="display:none">0</span></button><div class="update-info"><span class="update-time" id="lastUpdateTime">Actualizado ahora</span><span class="update-status synced" id="updateStatus">✓ Todo sincronizado</span></div></div>
                <div class="user-info"><div class="user-avatar" id="userAvatar">U</div><div class="user-details"><div class="user-name" id="userName">Usuario</div><div class="user-role"><span class="role-badge trabajador" id="userRoleBadge">Trabajador</span></div></div></div>
                <button class="btn btn-secondary btn-sm btn-block" style="margin-top:14px" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
            </div>
        </aside>
        <main class="main-content">
            <div class="view active" id="tasksView">
                <div class="page-header"><div class="page-title"><h1>Tareas</h1><p>Gestiona las tareas de tu equipo</p></div><div class="header-actions"><button class="btn btn-primary" onclick="openNewTaskModal()"><i class="fas fa-plus"></i> Nueva Tarea</button></div></div>
                <div class="filters-bar"><div class="filter-group"><label>Estado:</label><select class="filter-select" id="filterStatus" onchange="loadTasks()"><option value="">Todos</option><option value="pendiente">Pendiente</option><option value="en_progreso">En Progreso</option><option value="pausada">Pausada</option><option value="completada">Completada</option></select></div><div class="filter-group"><label>Prioridad:</label><select class="filter-select" id="filterPriority" onchange="loadTasks()"><option value="">Todas</option><option value="alta">Alta</option><option value="media">Media</option><option value="baja">Baja</option></select></div><div class="filter-group" id="filterWorkerGroup" style="display:none"><label>Trabajador:</label><select class="filter-select" id="filterWorker" onchange="loadTasks()"><option value="">Todos</option></select></div></div>
                <div class="tasks-container"><div class="task-column"><div class="column-header"><div class="column-title"><i class="fas fa-star" style="color:var(--warning)"></i> Principal</div><span class="column-count" id="countPrincipal">0</span></div><div class="column-body" id="columnPrincipal"><div class="loading"><div class="spinner"></div><span class="loading-text">Cargando...</span></div></div></div><div class="task-column"><div class="column-header"><div class="column-title"><i class="fas fa-clipboard-check" style="color:var(--info)"></i> Gestiones</div><span class="column-count" id="countGestion">0</span></div><div class="column-body" id="columnGestion"><div class="loading"><div class="spinner"></div><span class="loading-text">Cargando...</span></div></div></div><div class="task-column"><div class="column-header"><div class="column-title"><i class="fas fa-puzzle-piece" style="color:var(--success)"></i> Complementarios</div><span class="column-count" id="countComplementario">0</span></div><div class="column-body" id="columnComplementario"><div class="loading"><div class="spinner"></div><span class="loading-text">Cargando...</span></div></div></div></div>
            </div>
            <div class="view" id="dashboardView">
                <div class="page-header"><div class="page-title"><h1>Dashboard</h1><p>Métricas y estadísticas de productividad</p></div></div>
                <div class="filters-bar" style="margin-bottom:24px">
                    <div class="filter-group"><label><i class="fas fa-calendar-day"></i> Período:</label><select class="filter-select" id="dashboardPeriod" onchange="loadDashboard()"><option value="today">Hoy</option><option value="yesterday">Ayer</option><option value="week" selected>Esta Semana</option><option value="lastweek">Semana Pasada</option><option value="month">Este Mes</option><option value="lastmonth">Mes Pasado</option><option value="all">Todo (12 meses)</option></select></div>
                    <div class="filter-group" id="dashboardWorkerFilter" style="display:none"><label><i class="fas fa-user"></i> Trabajador:</label><select class="filter-select" id="dashboardWorker" onchange="loadDashboard()"><option value="">Todos</option></select></div>
                    <div class="filter-group"><label><i class="fas fa-layer-group"></i> Tipo:</label><select class="filter-select" id="dashboardType" onchange="loadDashboard()"><option value="">Todos</option><option value="principal">Principal</option><option value="gestion">Gestión</option><option value="complementario">Complementario</option></select></div>
                    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;font-size:0.85rem;color:var(--text-muted)"><i class="fas fa-info-circle"></i><span id="dashboardPeriodInfo">-</span></div>
                </div>
                <div class="stats-grid"><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Total Tareas</span><div class="stat-card-icon primary"><i class="fas fa-tasks"></i></div></div><div class="stat-card-value" id="statTotalTasks">0</div><div class="stat-card-change">En el período seleccionado</div></div><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Completadas</span><div class="stat-card-icon success"><i class="fas fa-check-circle"></i></div></div><div class="stat-card-value" id="statCompletedTasks">0</div><div class="stat-card-change">Tareas finalizadas</div></div><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Tiempo Promedio</span><div class="stat-card-icon warning"><i class="fas fa-clock"></i></div></div><div class="stat-card-value" id="statAvgTime">0m</div><div class="stat-card-change">Por tarea completada</div></div><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Efectividad</span><div class="stat-card-icon info"><i class="fas fa-percentage"></i></div></div><div class="stat-card-value" id="statEfficiency">0%</div><div class="stat-card-change">Tasa de completado</div></div></div>
                <div class="dashboard-grid" style="grid-template-columns:2fr 1fr"><div class="chart-card"><div class="chart-header"><h3 class="chart-title"><i class="fas fa-chart-line"></i> Productividad por Día</h3></div><div class="chart-container"><canvas id="productivityChart"></canvas></div></div><div class="chart-card"><div class="chart-header"><h3 class="chart-title"><i class="fas fa-chart-pie"></i> Distribución por Tipo</h3></div><div class="chart-container"><canvas id="typeDistributionChart"></canvas></div></div></div>
                <div class="dashboard-grid" style="grid-template-columns:1fr 1fr 1fr;margin-top:24px"><div class="chart-card"><div class="chart-header"><h3 class="chart-title"><i class="fas fa-users"></i> Rendimiento por Trabajador</h3></div><div class="chart-container"><canvas id="workerPerformanceChart"></canvas></div></div><div class="chart-card"><div class="chart-header"><h3 class="chart-title"><i class="fas fa-exclamation-circle"></i> Tareas por Prioridad</h3></div><div class="chart-container"><canvas id="priorityChart"></canvas></div></div><div class="chart-card"><div class="chart-header"><h3 class="chart-title"><i class="fas fa-hourglass-half"></i> Tiempo por Tipo</h3></div><div class="chart-container"><canvas id="timeByTypeChart"></canvas></div></div></div>
                <div class="chart-card" style="margin-top:24px"><div class="chart-header"><h3 class="chart-title"><i class="fas fa-table"></i> Detalle de Tareas</h3><div style="font-size:0.8rem;color:var(--text-muted)">Base jornada: 9.5h (570 min)</div></div><div class="table-container" style="overflow-x:auto"><table class="data-table" id="tasksDetailTable"><thead><tr><th>Usuario</th><th>Tipo</th><th>Título</th><th>Estado</th><th>Creada</th><th>Tiempo</th><th>% Jornada</th></tr></thead><tbody id="tasksDetailBody"><tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">Cargando datos...</td></tr></tbody><tfoot id="tasksDetailFooter"><tr><td colspan="7"></td></tr></tfoot></table></div></div>
            </div>
            <div class="view" id="workersView">
                <div class="page-header"><div class="page-title"><h1>Trabajadores</h1><p>Rendimiento y estadísticas del equipo</p></div></div>
                <div class="stats-grid"><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Total Trabajadores</span><div class="stat-card-icon primary"><i class="fas fa-users"></i></div></div><div class="stat-card-value" id="statTotalWorkers">0</div></div><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Activos Hoy</span><div class="stat-card-icon success"><i class="fas fa-user-check"></i></div></div><div class="stat-card-value" id="statActiveWorkers">0</div></div><div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Efectividad Promedio</span><div class="stat-card-icon info"><i class="fas fa-chart-line"></i></div></div><div class="stat-card-value" id="statAvgEfficiency">0%</div></div></div>
                <div class="workers-list" id="workersList"><div class="loading"><div class="spinner"></div><span class="loading-text">Cargando trabajadores...</span></div></div>
            </div>
        </main>
    </div>
    <div class="modal-overlay" id="newTaskModal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Nueva Tarea</h3><button class="modal-close" onclick="closeModal('newTaskModal')"><i class="fas fa-times"></i></button></div><form onsubmit="handleCreateTask(event)"><div class="modal-body"><div class="form-group"><label>Título de la tarea</label><input type="text" id="taskTitle" class="form-control" placeholder="Ej: Revisar documentos del proyecto" required></div><div class="form-group"><label>Descripción (opcional)</label><textarea id="taskDescription" class="form-control" placeholder="Detalles adicionales de la tarea..."></textarea></div><div class="form-group"><label>Tipo de tarea</label><select id="taskType" class="form-control" required><option value="principal">Tarea Principal</option><option value="gestion">Gestión</option><option value="complementario">Complementario</option></select></div><div class="form-group"><label>Prioridad</label><select id="taskPriority" class="form-control" required><option value="alta">Alta</option><option value="media" selected>Media</option><option value="baja">Baja</option></select></div><div class="form-group"><label>Asignar a</label><select id="taskAssignee" class="form-control" required></select></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('newTaskModal')">Cancelar</button><button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Crear Tarea</button></div></form></div></div>
    <div class="modal-overlay" id="taskDetailModal"><div class="modal" style="max-width:600px"><div class="modal-header"><h3 class="modal-title">Detalle de Tarea</h3><button class="modal-close" onclick="closeModal('taskDetailModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="taskDetailContent"><div class="loading"><div class="spinner"></div></div></div></div></div>
    <div class="toast-container" id="toastContainer"></div>
    <div class="connection-status connected" id="connectionStatus"><div class="connection-dot"></div><span>Conectado</span></div>
    <script>
        const SUPABASE_URL = 'https://jzjomvfwqvedsyvfcvto.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6am9tdmZ3cXZlZHN5dmZjdnRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTA1NzAsImV4cCI6MjA3OTE2NjU3MH0.Xp_Ns363pIG46EA_pqd-9bCwBRacrVfzwdIeKYyVBP8';
        const JEFE_SECRET_CODE = 'admin2024';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: localStorage, storageKey: 'taskflow-auth-v3' },
            realtime: { params: { eventsPerSecond: 10 } },
            global: { headers: { 'x-client-info': 'taskflow-pro' } }
        });
        let currentUser = null, currentProfile = null, charts = {}, activeTimers = {}, realtimeChannel = null;
        let isLoadingTasks = false, lastUpdateTime = new Date(), pendingChanges = 0, timeUpdaterInterval = null, reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        function formatDuration(minutes) { if (!minutes || minutes < 1) return '0m'; const h = Math.floor(minutes / 60), m = minutes % 60; return h === 0 ? `${m}m` : `${h}h ${m}m`; }
        function formatStatus(s) { const l = { pendiente: 'Pendiente', en_progreso: 'En Progreso', pausada: 'Pausada', completada: 'Completada' }; return l[s] || s; }
        function formatTaskType(t) { const l = { principal: 'Tarea Principal', gestion: 'Gestión', complementario: 'Complementario' }; return l[t] || t; }
        
        function showToast(msg, type = 'success') {
            const c = document.getElementById('toastContainer'); if (!c) return;
            const t = document.createElement('div'); t.className = `toast ${type}`;
            const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle' };
            t.innerHTML = `<i class="fas fa-${icons[type] || icons.success}"></i><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => { t.style.animation = 'toastSlide 0.3s ease reverse'; setTimeout(() => t.remove(), 300); }, 4000);
        }
        
        function updateConnectionStatus(connected) {
            const s = document.getElementById('connectionStatus'); if (!s) return;
            if (connected) { s.className = 'connection-status connected'; s.innerHTML = '<div class="connection-dot"></div><span>Conectado</span>'; reconnectAttempts = 0; }
            else { s.className = 'connection-status disconnected'; s.innerHTML = '<div class="connection-dot"></div><span>Desconectado</span>'; }
        }
        
        function formatRelativeTime(date) {
            const now = new Date(), diffMs = now - date, diffSecs = Math.floor(diffMs / 1000), diffMins = Math.floor(diffSecs / 60), diffHours = Math.floor(diffMins / 60);
            if (diffSecs < 10) return 'ahora'; if (diffSecs < 60) return `hace ${diffSecs}s`; if (diffMins < 60) return `hace ${diffMins}m`; if (diffHours < 24) return `hace ${diffHours}h`;
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }
        
        function updateLastUpdateTime() {
            lastUpdateTime = new Date(); pendingChanges = 0;
            const timeEl = document.getElementById('lastUpdateTime'), statusEl = document.getElementById('updateStatus'), badge = document.getElementById('updateBadge'), btn = document.getElementById('updateBtn');
            if (timeEl) timeEl.textContent = `Actualizado ${formatRelativeTime(lastUpdateTime)}`;
            if (statusEl) { statusEl.textContent = '✓ Todo sincronizado'; statusEl.className = 'update-status synced'; }
            if (badge) badge.style.display = 'none'; if (btn) btn.classList.remove('has-updates');
            startTimeUpdater();
        }
        
        function startTimeUpdater() { if (timeUpdaterInterval) clearInterval(timeUpdaterInterval); timeUpdaterInterval = setInterval(() => { const timeEl = document.getElementById('lastUpdateTime'); if (timeEl && lastUpdateTime) timeEl.textContent = `Actualizado ${formatRelativeTime(lastUpdateTime)}`; }, 30000); }
        
        function notifyPendingChange() {
            pendingChanges++;
            const badge = document.getElementById('updateBadge'), statusEl = document.getElementById('updateStatus'), btn = document.getElementById('updateBtn');
            if (badge) { badge.textContent = pendingChanges > 9 ? '9+' : pendingChanges; badge.style.display = 'flex'; }
            if (statusEl) { statusEl.textContent = `⚡ ${pendingChanges} cambio${pendingChanges > 1 ? 's' : ''} nuevo${pendingChanges > 1 ? 's' : ''}`; statusEl.className = 'update-status has-changes'; }
            if (btn) btn.classList.add('has-updates');
        }
        
        // Debounce para manualRefresh para evitar múltiples llamadas
        let refreshTimeout = null;
        let lastRefreshTime = 0;
        const MIN_REFRESH_INTERVAL = 2000; // Mínimo 2 segundos entre refrescos
        
        async function manualRefresh() {
            const now = Date.now();
            if (now - lastRefreshTime < MIN_REFRESH_INTERVAL) {
                console.log('Refresh muy reciente, saltando...');
                return;
            }
            lastRefreshTime = now;
            
            const btn = document.getElementById('updateBtn');
            if (btn) { btn.classList.add('loading'); btn.disabled = true; }
            
            try {
                const activeView = document.querySelector('.view.active');
                if (activeView?.id === 'tasksView') {
                    // Forzar reset del flag por si quedó atascado
                    isLoadingTasks = false;
                    await loadTasks();
                } else if (activeView?.id === 'dashboardView') {
                    await loadDashboard();
                } else if (activeView?.id === 'workersView') {
                    await loadWorkers();
                }
                updateLastUpdateTime();
                pendingChanges = 0;
                const statusEl = document.getElementById('updateStatus');
                if (statusEl) { statusEl.textContent = '✓ Todo sincronizado'; statusEl.className = 'update-status'; }
            } catch (e) {
                console.error('Error en refresh:', e);
                showToast('Error al actualizar', 'error');
            } finally {
                if (btn) { btn.classList.remove('loading'); btn.disabled = false; btn.classList.remove('has-updates'); }
            }
        }
        
        function toggleTheme() { const html = document.documentElement, currentTheme = html.getAttribute('data-theme'), newTheme = currentTheme === 'light' ? '' : 'light'; html.setAttribute('data-theme', newTheme); localStorage.setItem('taskflow-theme', newTheme ? 'light' : 'dark'); const label = document.getElementById('themeLabel'); if (label) label.textContent = newTheme ? 'Modo Claro' : 'Modo Oscuro'; if (Object.keys(charts).length > 0) loadDashboard(); }
        function loadTheme() { const savedTheme = localStorage.getItem('taskflow-theme'); if (savedTheme === 'light') { document.documentElement.setAttribute('data-theme', 'light'); const label = document.getElementById('themeLabel'); if (label) label.textContent = 'Modo Claro'; } }
        function showAuthTab(tab) { document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active')); event.target.classList.add('active'); document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none'; document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none'; }
        function toggleJefeCode() { const roleSelect = document.getElementById('registerRole'), codeGroup = document.getElementById('jefeCodeGroup'), codeInput = document.getElementById('jefeCode'); if (roleSelect.value === 'jefe') { codeGroup.classList.add('show'); codeInput.required = true; } else { codeGroup.classList.remove('show'); codeInput.required = false; } }
        
        async function handleLogin(e) {
            e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'), originalText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
            try { const email = document.getElementById('loginEmail').value.trim(), password = document.getElementById('loginPassword').value; const { data, error } = await supabase.auth.signInWithPassword({ email, password }); if (error) { if (error.message.includes('Invalid login credentials')) throw new Error('Email o contraseña incorrectos'); throw error; } showToast('¡Bienvenido!', 'success'); }
            catch (error) { console.error('Login error:', error); showToast(error.message || 'Error al iniciar sesión', 'error'); btn.disabled = false; btn.innerHTML = originalText; }
        }
        
        async function handleRegister(e) {
            e.preventDefault(); const role = document.getElementById('registerRole').value, jefeCode = document.getElementById('jefeCode').value;
            if (role === 'jefe' && jefeCode !== JEFE_SECRET_CODE) { showToast('Código de jefe incorrecto', 'error'); return; }
            const btn = e.target.querySelector('button[type="submit"]'), originalText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            try { const email = document.getElementById('registerEmail').value.trim(), password = document.getElementById('registerPassword').value, fullName = document.getElementById('registerName').value.trim(); const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { full_name: fullName, role: role } } }); if (error) throw error; showToast('¡Cuenta creada! Revisa tu email.', 'success'); document.querySelector('.auth-tab').click(); }
            catch (error) { console.error('Register error:', error); showToast(error.message || 'Error al crear cuenta', 'error'); }
            btn.disabled = false; btn.innerHTML = originalText;
        }
        
        async function handleLogout() { try { isManualCleanup = true; cleanupRealtime(); cleanupTimers(); await supabase.auth.signOut(); currentUser = null; currentProfile = null; isManualCleanup = false; showToast('Sesión cerrada', 'success'); } catch (error) { console.error('Logout error:', error); isManualCleanup = false; } }
        function cleanupTimers() { Object.values(activeTimers).forEach(timer => clearInterval(timer)); activeTimers = {}; if (timeUpdaterInterval) { clearInterval(timeUpdaterInterval); timeUpdaterInterval = null; } }
        
        // === REALTIME ROBUSTO ===
        let isManualCleanup = false;
        let isConnecting = false;
        let reconnectTimeout = null;
        const CHANNEL_NAME = 'taskflow-shared-changes'; // Canal FIJO compartido por todos
        
        function cleanupRealtime() {
            if (reconnectTimeout) { clearTimeout(reconnectTimeout); reconnectTimeout = null; }
            if (realtimeChannel) {
                console.log('Limpiando canal realtime...');
                try { supabase.removeChannel(realtimeChannel); } catch(e) { console.log('Error limpiando:', e); }
                realtimeChannel = null;
            }
        }

        async function setupRealtime() {
            // Evitar múltiples conexiones simultáneas
            if (isConnecting) { console.log('Ya conectando, ignorando...'); return; }
            if (!currentUser) { console.log('Sin usuario, no conectar'); return; }
            
            // Si ya tenemos un canal activo y conectado, no reconectar
            if (realtimeChannel && realtimeChannel.state === 'joined') {
                console.log('Canal ya conectado, ignorando...'); return;
            }
            
            isConnecting = true;
            
            // Limpiar canal anterior si existe (pero marcar como manual para no triggear reconexión)
            if (realtimeChannel) {
                isManualCleanup = true;
                cleanupRealtime();
                // Pequeño delay para que el servidor procese la desconexión
                await new Promise(r => setTimeout(r, 500));
                isManualCleanup = false;
            }
            
            console.log('Configurando canal:', CHANNEL_NAME);
            
            try {
                realtimeChannel = supabase.channel(CHANNEL_NAME, {
                    config: { broadcast: { self: false } }
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
                    console.log('Cambio en tasks:', payload.eventType);
                    notifyPendingChange();
                    // Actualizar automáticamente si estamos en la vista de tareas
                    const tasksView = document.getElementById('tasksView');
                    if (tasksView?.classList.contains('active')) {
                        debouncedLoadTasks();
                    }
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'task_sessions' }, (payload) => {
                    console.log('Cambio en sessions:', payload.eventType);
                    notifyPendingChange();
                    // Si hay tarea abierta, actualizar detalle
                    const tasksView = document.getElementById('tasksView');
                    if (tasksView?.classList.contains('active')) {
                        debouncedLoadTasks();
                    }
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => {
                    console.log('Cambio en profiles');
                    notifyPendingChange();
                })
                .subscribe((status, err) => {
                    console.log('Estado canal:', status, err || '');
                    isConnecting = false;
                    
                    switch(status) {
                        case 'SUBSCRIBED':
                            updateConnectionStatus(true);
                            reconnectAttempts = 0;
                            console.log('✅ Canal conectado exitosamente');
                            break;
                        case 'CHANNEL_ERROR':
                            console.warn('⚠️ Error en canal:', err);
                            updateConnectionStatus(false);
                            scheduleReconnect();
                            break;
                        case 'TIMED_OUT':
                            console.warn('⚠️ Timeout en canal');
                            updateConnectionStatus(false);
                            scheduleReconnect();
                            break;
                        case 'CLOSED':
                            console.log('Canal cerrado');
                            updateConnectionStatus(false);
                            // Solo reconectar si NO fue una limpieza manual
                            if (!isManualCleanup) {
                                scheduleReconnect();
                            }
                            break;
                    }
                });
            } catch (error) {
                console.error('Error creando canal:', error);
                isConnecting = false;
                scheduleReconnect();
            }
        }
        
        function scheduleReconnect() {
            if (reconnectTimeout) return; // Ya hay uno programado
            if (!currentUser) return; // No reconectar sin usuario
            if (isManualCleanup) return; // No reconectar si estamos limpiando
            
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = Math.min(3000 * Math.pow(1.5, reconnectAttempts - 1), 30000); // Exponential backoff, max 30s
                console.log(`Reconectando en ${delay}ms (intento ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`);
                
                reconnectTimeout = setTimeout(() => {
                    reconnectTimeout = null;
                    setupRealtime();
                }, delay);
            } else {
                console.error('❌ Máximo de reintentos alcanzado');
                showToast('Conexión perdida. Por favor recarga la página.', 'error');
            }
        }
        
        const debouncedLoadTasks = debounce(() => { loadTasks(); }, 1000);

        async function initApp() { console.log('Inicializando TaskFlow Pro...'); const { data: { session } } = await supabase.auth.getSession(); if (session) { currentUser = session.user; await loadUserProfile(); showApp(); } else showAuth(); supabase.auth.onAuthStateChange(async (event, session) => { console.log('Auth state:', event); if (event === 'SIGNED_IN' && session) { currentUser = session.user; await loadUserProfile(); showApp(); } else if (event === 'SIGNED_OUT') { currentUser = null; currentProfile = null; showAuth(); } }); }

        async function loadUserProfile() { if (!currentUser) return; try { const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single(); if (error) { if (error.code === 'PGRST116') { const { data: newProfile } = await supabase.from('profiles').insert([{ id: currentUser.id, full_name: currentUser.user_metadata?.full_name || 'Usuario', role: currentUser.user_metadata?.role || 'trabajador' }]).select().single(); if (newProfile) currentProfile = newProfile; } return; } if (data) { currentProfile = data; updateUserUI(); } } catch (err) { console.error('Error perfil:', err); } }

        function updateUserUI() { if (!currentProfile) return; const userName = document.getElementById('userName'), userAvatar = document.getElementById('userAvatar'), userRoleBadge = document.getElementById('userRoleBadge'); if (userName) userName.textContent = currentProfile.full_name || 'Usuario'; if (userAvatar) userAvatar.textContent = (currentProfile.full_name || 'U').charAt(0).toUpperCase(); if (userRoleBadge) { userRoleBadge.textContent = currentProfile.role === 'jefe' ? 'Jefe' : 'Trabajador'; userRoleBadge.className = `role-badge ${currentProfile.role}`; } const isJefe = currentProfile.role === 'jefe'; const navWorkersSection = document.getElementById('navWorkersSection'); if (navWorkersSection) navWorkersSection.style.display = isJefe ? 'block' : 'none'; const filterWorkerGroup = document.getElementById('filterWorkerGroup'); if (filterWorkerGroup) filterWorkerGroup.style.display = isJefe ? 'flex' : 'none'; const taskTypeSelect = document.getElementById('taskType'); if (taskTypeSelect && !isJefe) { const principalOption = taskTypeSelect.querySelector('option[value="principal"]'); if (principalOption) { principalOption.disabled = true; principalOption.textContent = 'Tarea Principal (Solo jefes)'; } } }

        function showAuth() { document.getElementById('authContainer').style.display = 'flex'; document.getElementById('appContainer').style.display = 'none'; document.getElementById('connectionStatus').style.display = 'none'; }
        function showApp() { document.getElementById('authContainer').style.display = 'none'; document.getElementById('appContainer').style.display = 'block'; document.getElementById('connectionStatus').style.display = 'flex'; loadTasks(); if (currentProfile?.role === 'jefe') { loadWorkers(); loadWorkersFilter(); } setupRealtime(); updateLastUpdateTime(); }
        function showView(viewName) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); const view = document.getElementById(`${viewName}View`); if (view) view.classList.add('active'); if (event && event.target) { const navItem = event.target.closest('.nav-item'); if (navItem) navItem.classList.add('active'); } if (viewName === 'dashboard') loadDashboard(); else if (viewName === 'workers') loadWorkers(); else if (viewName === 'tasks') loadTasks(); }

        async function loadTasks() {
            // Evitar llamadas simultáneas, pero con timeout de seguridad
            if (isLoadingTasks) {
                console.log('loadTasks ya en ejecución, saltando...');
                return;
            }
            isLoadingTasks = true;
            
            const columns = { principal: document.getElementById('columnPrincipal'), gestion: document.getElementById('columnGestion'), complementario: document.getElementById('columnComplementario') };
            Object.values(columns).forEach(col => { if (col) col.innerHTML = `<div class="loading"><div class="spinner"></div><span class="loading-text">Cargando...</span></div>`; });
            
            // Timeout de seguridad para evitar loading infinito
            const loadingTimeout = setTimeout(() => {
                console.warn('Timeout en loadTasks - reseteando...');
                isLoadingTasks = false;
            }, 15000);
            
            try {
                const statusFilter = document.getElementById('filterStatus')?.value;
                const priorityFilter = document.getElementById('filterPriority')?.value;
                const workerFilter = document.getElementById('filterWorker')?.value;
                
                let query = supabase.from('tasks').select(`
                    id, title, description, task_type, priority, status, created_at, assigned_to, created_by,
                    assigned_profile:profiles!tasks_assigned_to_fkey(id, full_name),
                    created_profile:profiles!tasks_created_by_fkey(id, full_name),
                    task_sessions(id, duration_minutes, is_active, start_time)
                `).order('created_at', { ascending: false });
                
                if (statusFilter) query = query.eq('status', statusFilter);
                if (priorityFilter) query = query.eq('priority', priorityFilter);
                if (workerFilter) query = query.eq('assigned_to', workerFilter);
                
                const { data: tasks, error } = await query;
                
                clearTimeout(loadingTimeout);
                
                if (error) throw error;
                
                console.log(`Tareas cargadas: ${tasks?.length || 0}`);
                renderTasks(tasks || []);
                updateLastUpdateTime();
            } catch (error) {
                clearTimeout(loadingTimeout);
                console.error('Error cargando tareas:', error);
                Object.values(columns).forEach(col => {
                    if (col) col.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error al cargar</p></div>`;
                });
                showToast('Error al cargar tareas', 'error');
            } finally {
                isLoadingTasks = false;
            }
        }

        function renderTasks(tasks) {
            console.log('renderTasks iniciando...', tasks?.length || 0);
            try {
                const columns = {
                    principal: document.getElementById('columnPrincipal'),
                    gestion: document.getElementById('columnGestion'),
                    complementario: document.getElementById('columnComplementario')
                };
                const counts = { principal: 0, gestion: 0, complementario: 0 };
                
                // Limpiar columnas
                Object.values(columns).forEach(col => { if (col) col.innerHTML = ''; });
                
                if (!tasks || tasks.length === 0) {
                    Object.values(columns).forEach(col => {
                        if (col) col.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay tareas</p></div>`;
                    });
                    document.getElementById('countPrincipal').textContent = '0';
                    document.getElementById('countGestion').textContent = '0';
                    document.getElementById('countComplementario').textContent = '0';
                    console.log('renderTasks: sin tareas');
                    return;
                }
                
                tasks.forEach(task => {
                    const column = columns[task.task_type];
                    if (!column) {
                        console.warn('Columna no encontrada para tipo:', task.task_type);
                        return;
                    }
                    counts[task.task_type]++;
                    
                    const totalMinutes = (task.task_sessions || []).filter(s => !s.is_active).reduce((sum, s) => sum + (s.duration_minutes || 0), 0);
                    const hasActiveSession = (task.task_sessions || []).some(s => s.is_active);
                    const assigneeName = task.assigned_profile?.full_name || 'Sin asignar';
                    
                    const card = document.createElement('div');
                    card.className = 'task-card';
                    card.onclick = () => openTaskDetail(task);
                    card.innerHTML = `
                        <div class="task-card-header">
                            <span class="task-priority priority-${task.priority}">${task.priority}</span>
                            <span class="task-status-badge status-${task.status}">${hasActiveSession ? '<span class="active-indicator"></span>' : ''}${formatStatus(task.status)}</span>
                        </div>
                        <div class="task-title">${task.title || 'Sin título'}</div>
                        <div class="task-meta">
                            <div class="task-assignee">
                                <div class="task-assignee-avatar">${assigneeName.charAt(0).toUpperCase()}</div>
                                <span>${assigneeName}</span>
                            </div>
                            ${totalMinutes > 0 ? `<span class="task-time"><i class="fas fa-clock"></i>${formatDuration(totalMinutes)}</span>` : ''}
                        </div>
                    `;
                    column.appendChild(card);
                });
                
                // Mostrar mensaje vacío en columnas sin tareas
                Object.keys(columns).forEach(type => {
                    if (counts[type] === 0 && columns[type]) {
                        columns[type].innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay tareas</p></div>`;
                    }
                });
                
                // Actualizar contadores
                document.getElementById('countPrincipal').textContent = counts.principal;
                document.getElementById('countGestion').textContent = counts.gestion;
                document.getElementById('countComplementario').textContent = counts.complementario;
                
                console.log('renderTasks completado:', counts);
            } catch (error) {
                console.error('Error en renderTasks:', error);
            }
        }

        async function openNewTaskModal() { document.getElementById('newTaskModal').classList.add('active'); await loadAssignees(); }
        async function loadAssignees() { try { const { data: profiles, error } = await supabase.from('profiles').select('id, full_name, role').order('full_name'); if (error) throw error; const select = document.getElementById('taskAssignee'); select.innerHTML = ''; (profiles || []).forEach(profile => { const option = document.createElement('option'); option.value = profile.id; option.textContent = `${profile.full_name} (${profile.role})`; if (currentUser && profile.id === currentUser.id) option.selected = true; select.appendChild(option); }); } catch (error) { console.error('Error cargando asignados:', error); } }
        async function loadWorkersFilter() { try { const { data: profiles, error } = await supabase.from('profiles').select('id, full_name').order('full_name'); if (error) throw error; const select = document.getElementById('filterWorker'); select.innerHTML = '<option value="">Todos</option>'; (profiles || []).forEach(profile => { const option = document.createElement('option'); option.value = profile.id; option.textContent = profile.full_name; select.appendChild(option); }); } catch (error) { console.error('Error filtro trabajadores:', error); } }

        async function handleCreateTask(e) {
            e.preventDefault(); const taskType = document.getElementById('taskType').value;
            if (taskType === 'principal' && currentProfile?.role !== 'jefe') { showToast('Solo el jefe puede crear tareas principales', 'error'); return; }
            const btn = e.target.querySelector('button[type="submit"]'), originalText = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            try { const taskData = { title: document.getElementById('taskTitle').value.trim(), description: document.getElementById('taskDescription').value.trim(), task_type: taskType, priority: document.getElementById('taskPriority').value, assigned_to: document.getElementById('taskAssignee').value, created_by: currentUser.id, status: 'pendiente' }; const { data, error } = await supabase.from('tasks').insert([taskData]).select().single(); if (error) throw error; showToast('Tarea creada correctamente', 'success'); closeModal('newTaskModal'); e.target.reset(); await loadTasks(); }
            catch (error) { console.error('Error creando tarea:', error); showToast('Error al crear la tarea: ' + error.message, 'error'); }
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        }

        async function openTaskDetail(task) {
            if (!task || !task.id) {
                console.error('Tarea inválida:', task);
                showToast('Error: tarea no válida', 'error');
                return;
            }
            
            document.getElementById('taskDetailModal').classList.add('active');
            document.getElementById('taskDetailContent').innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
            
            // Timeout de seguridad
            const detailTimeout = setTimeout(() => {
                console.warn('Timeout cargando detalle de tarea');
                document.getElementById('taskDetailContent').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Tiempo de espera agotado. Intenta de nuevo.</p></div>`;
            }, 10000);
            
            try {
                const { data: sessions, error: sessionsError } = await supabase
                    .from('task_sessions')
                    .select('*')
                    .eq('task_id', task.id)
                    .order('start_time', { ascending: false });
                
                clearTimeout(detailTimeout);
                
                if (sessionsError) throw sessionsError;
                
                const activeSession = (sessions || []).find(s => s.is_active);
                const totalMinutes = (sessions || []).filter(s => !s.is_active).reduce((sum, s) => sum + (s.duration_minutes || 0), 0);
                const isOwner = task.assigned_to === currentUser?.id;
                const isJefe = currentProfile?.role === 'jefe';
                const canControl = isOwner || isJefe;
                
                let actionsHTML = '';
                if (task.status !== 'completada') {
                    if (!activeSession && (task.status === 'pendiente' || task.status === 'pausada')) {
                        const btnText = task.status === 'pausada' ? 'Reanudar' : 'Iniciar';
                        actionsHTML += `<button class="btn btn-success btn-sm" onclick="startTask('${task.id}')" ${!canControl ? 'disabled title="No tienes permiso"' : ''}><i class="fas fa-play"></i> ${btnText}</button>`;
                    }
                    if (activeSession) {
                        actionsHTML += `<button class="btn btn-warning btn-sm" onclick="pauseTask('${task.id}')" ${!isJefe ? 'disabled title="Solo el jefe puede pausar"' : ''}><i class="fas fa-pause"></i> Pausar</button>`;
                        actionsHTML += `<button class="btn btn-success btn-sm" onclick="completeTask('${task.id}')" ${!isJefe ? 'disabled title="Solo el jefe puede completar"' : ''}><i class="fas fa-check"></i> Completar</button>`;
                    }
                }
                if (isJefe) actionsHTML += `<button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')"><i class="fas fa-trash"></i> Eliminar</button>`;
                
                document.getElementById('taskDetailContent').innerHTML = `
                    <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
                        <span class="task-priority priority-${task.priority}">${task.priority}</span>
                        <span class="task-status-badge status-${task.status}">${activeSession ? '<span class="active-indicator"></span>' : ''}${formatStatus(task.status)}</span>
                    </div>
                    <h2 style="font-size:1.4rem;font-weight:700;margin-bottom:12px">${task.title}</h2>
                    ${task.description ? `<p style="color:var(--text-secondary);margin-bottom:24px;line-height:1.6">${task.description}</p>` : ''}
                    <div class="time-tracker">
                        <div class="time-display" id="timerDisplay-${task.id}">${formatDuration(totalMinutes)}</div>
                        ${activeSession ? `<div class="time-status active"><span class="time-status-dot"></span>En progreso</div>` : ''}
                    </div>
                    <div class="task-detail-meta">
                        <div class="meta-item"><div class="meta-label">Tipo</div><div class="meta-value">${formatTaskType(task.task_type)}</div></div>
                        <div class="meta-item"><div class="meta-label">Asignado a</div><div class="meta-value">${task.assigned_profile?.full_name || 'N/A'}</div></div>
                        <div class="meta-item"><div class="meta-label">Creado por</div><div class="meta-value">${task.created_profile?.full_name || 'N/A'}</div></div>
                        <div class="meta-item"><div class="meta-label">Fecha de creación</div><div class="meta-value">${new Date(task.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div></div>
                    </div>
                    <div class="task-actions">${actionsHTML}</div>
                    ${!isJefe && task.status !== 'completada' && activeSession ? `<div class="info-note"><i class="fas fa-info-circle"></i>Solo el jefe puede completar o pausar las tareas</div>` : ''}
                `;
                
                if (activeSession) startVisualTimer(task.id, activeSession.start_time, totalMinutes);
            } catch (error) {
                clearTimeout(detailTimeout);
                console.error('Error cargando detalle:', error);
                document.getElementById('taskDetailContent').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error al cargar los detalles</p><button class="btn btn-primary btn-sm" onclick="closeModal('taskDetailModal')">Cerrar</button></div>`;
            }
        }

        function startVisualTimer(taskId, startTime, baseMinutes) { const display = document.getElementById(`timerDisplay-${taskId}`); if (!display) return; if (activeTimers[taskId]) clearInterval(activeTimers[taskId]); const startDate = new Date(startTime); activeTimers[taskId] = setInterval(() => { const now = new Date(); const elapsedMs = now - startDate; const elapsedMins = Math.floor(elapsedMs / 60000); const totalMins = baseMinutes + elapsedMins; if (display) display.textContent = formatDuration(totalMins); }, 1000); }

        async function startTask(taskId) { const btn = event?.target?.closest('button'); if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; } try { const { error: sessionError } = await supabase.from('task_sessions').insert([{ task_id: taskId, user_id: currentUser.id, start_time: new Date().toISOString(), is_active: true }]); if (sessionError) throw sessionError; const { error: taskError } = await supabase.from('tasks').update({ status: 'en_progreso' }).eq('id', taskId); if (taskError) throw taskError; showToast('Tarea iniciada', 'success'); closeModal('taskDetailModal'); await loadTasks(); } catch (error) { console.error('Error al iniciar tarea:', error); showToast('Error al iniciar la tarea: ' + error.message, 'error'); if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-play"></i> Iniciar'; } } }

        async function pauseTask(taskId) { if (currentProfile?.role !== 'jefe') { showToast('Solo el jefe puede pausar tareas', 'error'); return; } const btn = event?.target?.closest('button'); if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; } try { const { data: activeSession } = await supabase.from('task_sessions').select('*').eq('task_id', taskId).eq('is_active', true).single(); if (activeSession) { const startTime = new Date(activeSession.start_time); const endTime = new Date(); const durationMinutes = Math.round((endTime - startTime) / 60000); await supabase.from('task_sessions').update({ end_time: endTime.toISOString(), duration_minutes: durationMinutes, is_active: false }).eq('id', activeSession.id); } const { error: taskError } = await supabase.from('tasks').update({ status: 'pausada' }).eq('id', taskId); if (taskError) throw taskError; showToast('Tarea pausada', 'success'); closeModal('taskDetailModal'); await loadTasks(); } catch (error) { console.error('Error al pausar tarea:', error); showToast('Error al pausar la tarea: ' + error.message, 'error'); } }

        async function completeTask(taskId) { if (currentProfile?.role !== 'jefe') { showToast('Solo el jefe puede completar tareas', 'error'); return; } const btn = event?.target?.closest('button'); if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; } try { const { data: activeSession } = await supabase.from('task_sessions').select('*').eq('task_id', taskId).eq('is_active', true).maybeSingle(); if (activeSession) { const startTime = new Date(activeSession.start_time); const endTime = new Date(); const durationMinutes = Math.round((endTime - startTime) / 60000); await supabase.from('task_sessions').update({ end_time: endTime.toISOString(), duration_minutes: durationMinutes, is_active: false }).eq('id', activeSession.id); } const { error } = await supabase.from('tasks').update({ status: 'completada' }).eq('id', taskId); if (error) throw error; showToast('¡Tarea completada!', 'success'); closeModal('taskDetailModal'); await loadTasks(); } catch (error) { console.error('Error al completar tarea:', error); showToast('Error al completar la tarea: ' + error.message, 'error'); } }

        async function deleteTask(taskId) { if (!confirm('¿Estás seguro de que deseas eliminar esta tarea?')) return; try { const { error } = await supabase.from('tasks').delete().eq('id', taskId); if (error) throw error; showToast('Tarea eliminada', 'success'); closeModal('taskDetailModal'); await loadTasks(); } catch (error) { console.error('Error al eliminar tarea:', error); showToast('Error al eliminar la tarea: ' + error.message, 'error'); } }

        async function loadDashboard() {
            const period = document.getElementById('dashboardPeriod')?.value || 'week';
            const workerFilter = document.getElementById('dashboardWorker')?.value || '';
            const typeFilter = document.getElementById('dashboardType')?.value || '';
            const { startDate, endDate, label } = getDateRange(period);
            const periodInfo = document.getElementById('dashboardPeriodInfo');
            if (periodInfo) periodInfo.textContent = label;
            if (currentProfile?.role === 'jefe') {
                const dwf = document.getElementById('dashboardWorkerFilter');
                if (dwf) dwf.style.display = 'flex';
                await loadDashboardWorkersFilter();
            }
            try {
                let query = supabase.from('tasks').select(`*, assigned_profile:profiles!tasks_assigned_to_fkey(id, full_name), task_sessions(duration_minutes, is_active, start_time, end_time)`);
                if (currentProfile?.role !== 'jefe') query = query.eq('assigned_to', currentUser.id);
                if (workerFilter) query = query.eq('assigned_to', workerFilter);
                if (typeFilter) query = query.eq('task_type', typeFilter);
                query = query.gte('created_at', startDate.toISOString()).lte('created_at', endDate.toISOString());
                const { data: tasks, error } = await query;
                if (error) throw error;
                if (tasks) { updateDashboardStats(tasks); updateCharts(tasks); updateDetailTable(tasks); }
            } catch (error) { console.error('Error cargando dashboard:', error); }
        }

        async function loadDashboardWorkersFilter() {
            const select = document.getElementById('dashboardWorker'); if (!select || select.options.length > 1) return;
            try { const { data: profiles } = await supabase.from('profiles').select('id, full_name').order('full_name');
                (profiles || []).forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.full_name; select.appendChild(opt); });
            } catch (e) { console.error(e); }
        }

        function getDateRange(period) {
            const now = new Date(); let startDate, endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59), label = '';
            switch (period) {
                case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0); label = `Hoy: ${startDate.toLocaleDateString('es-ES')}`; break;
                case 'yesterday': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 0, 0, 0); endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, 23, 59, 59); label = `Ayer: ${startDate.toLocaleDateString('es-ES')}`; break;
                case 'week': const dow = now.getDay(); startDate = new Date(now); startDate.setDate(now.getDate() - dow); startDate.setHours(0, 0, 0, 0); label = `${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}`; break;
                case 'lastweek': const dow2 = now.getDay(); startDate = new Date(now); startDate.setDate(now.getDate() - dow2 - 7); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59); label = `${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}`; break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); label = now.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }); break;
                case 'lastmonth': startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1); endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59); label = startDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }); break;
                default: startDate = new Date(now.getFullYear() - 1, now.getMonth(), 1); label = 'Últimos 12 meses';
            }
            return { startDate, endDate, label };
        }

        function updateDashboardStats(tasks) {
            const total = tasks.length, completed = tasks.filter(t => t.status === 'completada').length;
            const totalMinutes = tasks.reduce((sum, task) => sum + (task.task_sessions || []).reduce((s, ses) => s + (ses.duration_minutes || 0), 0), 0);
            const avgTime = completed > 0 ? Math.round(totalMinutes / completed) : 0;
            const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('statTotalTasks').textContent = total;
            document.getElementById('statCompletedTasks').textContent = completed;
            document.getElementById('statAvgTime').textContent = formatDuration(avgTime);
            document.getElementById('statEfficiency').textContent = `${efficiency}%`;
        }

        function updateCharts(tasks) {
            Object.values(charts).forEach(c => c?.destroy()); charts = {};
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#a1a1aa';
            const gridColor = 'rgba(255,255,255,0.05)';
            // 1. Productividad por día
            const dailyData = {};
            tasks.forEach(t => { const d = new Date(t.created_at).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }); if (!dailyData[d]) dailyData[d] = { created: 0, completed: 0 }; dailyData[d].created++; if (t.status === 'completada') dailyData[d].completed++; });
            const ctx1 = document.getElementById('productivityChart');
            if (ctx1) charts.productivity = new Chart(ctx1, { type: 'line', data: { labels: Object.keys(dailyData), datasets: [{ label: 'Completadas', data: Object.values(dailyData).map(d => d.completed), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4 }, { label: 'Creadas', data: Object.values(dailyData).map(d => d.created), borderColor: '#7c3aed', backgroundColor: 'rgba(124,58,237,0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } }, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true } } } });
            // 2. Distribución por tipo
            const typeData = { principal: tasks.filter(t => t.task_type === 'principal').length, gestion: tasks.filter(t => t.task_type === 'gestion').length, complementario: tasks.filter(t => t.task_type === 'complementario').length };
            const ctx2 = document.getElementById('typeDistributionChart');
            if (ctx2) charts.distribution = new Chart(ctx2, { type: 'doughnut', data: { labels: ['Principal', 'Gestión', 'Complementario'], datasets: [{ data: [typeData.principal, typeData.gestion, typeData.complementario], backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 15, usePointStyle: true } } } } });
            // 3. Rendimiento por trabajador
            const workerData = {};
            tasks.forEach(t => { const name = t.assigned_profile?.full_name || 'Sin asignar'; if (!workerData[name]) workerData[name] = { total: 0, completed: 0, time: 0 }; workerData[name].total++; if (t.status === 'completada') workerData[name].completed++; workerData[name].time += (t.task_sessions || []).reduce((s, ses) => s + (ses.duration_minutes || 0), 0); });
            const ctx3 = document.getElementById('workerPerformanceChart');
            if (ctx3) charts.workerPerf = new Chart(ctx3, { type: 'bar', data: { labels: Object.keys(workerData), datasets: [{ label: 'Completadas', data: Object.values(workerData).map(w => w.completed), backgroundColor: '#10b981' }, { label: 'Total', data: Object.values(workerData).map(w => w.total), backgroundColor: '#7c3aed' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } }, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true } } } });
            // 4. Tareas por prioridad
            const prioData = { alta: tasks.filter(t => t.priority === 'alta').length, media: tasks.filter(t => t.priority === 'media').length, baja: tasks.filter(t => t.priority === 'baja').length };
            const ctx4 = document.getElementById('priorityChart');
            if (ctx4) charts.priority = new Chart(ctx4, { type: 'bar', data: { labels: ['Alta', 'Media', 'Baja'], datasets: [{ label: 'Tareas', data: [prioData.alta, prioData.media, prioData.baja], backgroundColor: ['#ef4444', '#f59e0b', '#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true }, y: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
            // 5. Tiempo por tipo
            const timeByType = { principal: 0, gestion: 0, complementario: 0 };
            tasks.forEach(t => { const mins = (t.task_sessions || []).reduce((s, ses) => s + (ses.duration_minutes || 0), 0); timeByType[t.task_type] = (timeByType[t.task_type] || 0) + mins; });
            const ctx5 = document.getElementById('timeByTypeChart');
            if (ctx5) charts.timeType = new Chart(ctx5, { type: 'bar', data: { labels: ['Principal', 'Gestión', 'Complementario'], datasets: [{ label: 'Minutos', data: [timeByType.principal, timeByType.gestion, timeByType.complementario], backgroundColor: ['#f59e0b', '#3b82f6', '#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { color: textColor, callback: v => formatDuration(v) }, grid: { color: gridColor }, beginAtZero: true }, y: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
        }

        function updateDetailTable(tasks) {
            const JORNADA_MINS = 570; // 9.5 horas
            const tbody = document.getElementById('tasksDetailBody');
            const tfoot = document.getElementById('tasksDetailFooter');
            if (!tbody) return;
            if (!tasks || tasks.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No hay tareas en este período</td></tr>'; tfoot.innerHTML = ''; return; }
            let totalTime = 0;
            const rows = tasks.map(t => {
                const mins = (t.task_sessions || []).reduce((s, ses) => s + (ses.duration_minutes || 0), 0);
                totalTime += mins;
                const pctJornada = Math.round((mins / JORNADA_MINS) * 100);
                const jornadaClass = pctJornada < 20 ? 'jornada-low' : pctJornada < 50 ? 'jornada-medium' : 'jornada-high';
                return `<tr>
                    <td><div style="display:flex;align-items:center;gap:8px"><div class="task-assignee-avatar">${(t.assigned_profile?.full_name || 'S').charAt(0)}</div>${t.assigned_profile?.full_name || 'Sin asignar'}</div></td>
                    <td><span class="task-priority priority-${t.task_type === 'principal' ? 'alta' : t.task_type === 'gestion' ? 'media' : 'baja'}">${formatTaskType(t.task_type)}</span></td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.title}">${t.title}</td>
                    <td><span class="task-status-badge status-${t.status}">${formatStatus(t.status)}</span></td>
                    <td style="font-size:0.8rem;color:var(--text-muted)">${new Date(t.created_at).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })}</td>
                    <td><strong>${formatDuration(mins)}</strong></td>
                    <td><span class="jornada-badge ${jornadaClass}">${pctJornada}%</span></td>
                </tr>`;
            }).join('');
            tbody.innerHTML = rows;
            const avgTime = tasks.length > 0 ? Math.round(totalTime / tasks.length) : 0;
            tfoot.innerHTML = `<tr><td colspan="7"><div class="summary-row">
                <div class="summary-item"><span class="summary-label">Total tareas:</span><span class="summary-value">${tasks.length}</span></div>
                <div class="summary-item"><span class="summary-label">Tiempo total:</span><span class="summary-value">${formatDuration(totalTime)}</span></div>
                <div class="summary-item"><span class="summary-label">Promedio:</span><span class="summary-value">${formatDuration(avgTime)}</span></div>
                <div class="summary-item"><span class="summary-label">% Jornada total:</span><span class="summary-value">${Math.round((totalTime / JORNADA_MINS) * 100)}%</span></div>
            </div></td></tr>`;
        }

        async function loadWorkers() {
            const container = document.getElementById('workersList'); container.innerHTML = `<div class="loading"><div class="spinner"></div><span class="loading-text">Cargando trabajadores...</span></div>`;
            try { const { data: workers, error } = await supabase.from('profiles').select(`*, tasks:tasks!tasks_assigned_to_fkey(id, status, task_sessions(duration_minutes, is_active))`).order('full_name'); if (error) throw error;
                if (!workers || workers.length === 0) { container.innerHTML = `<div class="empty-state"><i class="fas fa-users"></i><p>No hay trabajadores registrados</p></div>`; return; }
                const workersStats = workers.map(worker => { const tasks = worker.tasks || []; const totalTasks = tasks.length; const completedTasks = tasks.filter(t => t.status === 'completada').length; const totalMinutes = tasks.reduce((sum, task) => sum + (task.task_sessions || []).filter(s => !s.is_active).reduce((s, session) => s + (session.duration_minutes || 0), 0), 0); const efficiency = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0; return { ...worker, totalTasks, completedTasks, totalMinutes, efficiency }; });
                container.innerHTML = workersStats.map(worker => `<div class="worker-item" onclick="viewWorkerTasks('${worker.id}')"><div class="worker-avatar">${(worker.full_name || 'U').charAt(0).toUpperCase()}</div><div class="worker-info"><div class="worker-name">${worker.full_name || 'Usuario'}</div><div class="worker-stats">${worker.completedTasks}/${worker.totalTasks} tareas • ${formatDuration(worker.totalMinutes)} trabajados</div></div><div class="worker-efficiency"><div class="efficiency-value" style="color:${worker.efficiency >= 70 ? 'var(--success)' : worker.efficiency >= 40 ? 'var(--warning)' : 'var(--danger)'}">${worker.efficiency}%</div><div class="efficiency-label">Efectividad</div></div></div>`).join('');
                const totalWorkers = workersStats.length; const activeWorkers = workersStats.filter(w => w.totalTasks > 0).length; const avgEfficiency = totalWorkers > 0 ? Math.round(workersStats.reduce((sum, w) => sum + w.efficiency, 0) / totalWorkers) : 0;
                document.getElementById('statTotalWorkers').textContent = totalWorkers; document.getElementById('statActiveWorkers').textContent = activeWorkers; document.getElementById('statAvgEfficiency').textContent = `${avgEfficiency}%`;
            } catch (error) { console.error('Error cargando trabajadores:', error); container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error al cargar trabajadores</p></div>`; }
        }

        function viewWorkerTasks(workerId) { document.getElementById('filterWorker').value = workerId; showView('tasks'); loadTasks(); }
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('active'); Object.values(activeTimers).forEach(timer => clearInterval(timer)); activeTimers = {}; }

        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) { e.target.classList.remove('active'); Object.values(activeTimers).forEach(timer => clearInterval(timer)); activeTimers = {}; } });
        document.addEventListener('DOMContentLoaded', () => { loadTheme(); initApp(); });
        
        // Reconectar cuando la página vuelve a estar visible (con debounce)
        let visibilityTimeout = null;
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && currentUser) {
                // Usar debounce para evitar múltiples llamadas
                if (visibilityTimeout) clearTimeout(visibilityTimeout);
                
                visibilityTimeout = setTimeout(() => {
                    console.log('Página visible - verificando conexión...');
                    // Solo reconectar si el canal no está activo
                    if (!realtimeChannel || realtimeChannel.state !== 'joined') {
                        console.log('Canal no conectado, iniciando reconexión...');
                        reconnectAttempts = 0;
                        setupRealtime();
                    }
                    // Refrescar datos
                    manualRefresh();
                }, 500); // Esperar 500ms antes de actuar
            }
        });
        
        // Verificación periódica de conexión (cada 60 segundos)
        setInterval(() => {
            if (currentUser && document.visibilityState === 'visible' && !isConnecting) {
                if (!realtimeChannel || realtimeChannel.state !== 'joined') {
                    console.log('Verificación periódica: canal desconectado');
                    reconnectAttempts = 0;
                    setupRealtime();
                }
            }
        }, 60000);
    </script>
</body>
</html>
